<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Tạ Minh Quân,ta.quan@icloud.com"><title>My simple location based application · Tạ Quân</title><meta name="description" content="DummyMap is a simple location based application on IOS. It’s been designed to show location of 4 types of restaurant in Ha Noi. All data use in this p"><meta name="keywords" content="Hexo,Swift,Refactoring,iOS,Docker"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Tạ Quân</a></h3><div class="description"><p>Just make it simple.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/quanrong"><i class="fa fa-twitter"></i></a></li><li><a href="http://facebook.com/churongmayman"><i class="fa fa-facebook"></i></a></li><li><a href="http://github.com/quanrong88"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Archive</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"></a></li></div><div class="avatar"><img src="/images/blog_ava.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>My simple location based application</a></h3></div><div class="post-content"><p><strong>DummyMap</strong> is a simple location based application on IOS. It’s been designed to show location of 4 types of restaurant in Ha Noi. All data use in this project is no real. App’s designed to use collection view for presenting list restaurant data and use map view for presenting location on map. After complete project we will have a simple IOS application with 2 tabs and learn how to use collection view and map view to show data from server.</p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p>The app presents dummy restaurants location and information on feeds and map view. You can browse the restaurants on feeds list information and more visually with map view.</p>
<img src="/2017/12/19/My-simple-location-based-application/feeds-portrait-mode.png" title="Feeds screen on portrait">
<p><em>Feeds screen on portrait mode</em><br><img src="/2017/12/19/My-simple-location-based-application/feeds-landscape-mode.png" title="Feeds screen on landscape"><br><em>Feeds screen on landscape mode</em></p>
<p>The feeds screen is built using a <strong>UICollectionView</strong> with a custom flow layout. At the first sight, it looks like table view when device in portrait mode but when you rotate the device to landscape it will change the layout to 3 items per row because there are a lot of free space I don’t want to waste it.</p>
<img src="/2017/12/19/My-simple-location-based-application/map-item-annotation.png" title="Map view annotation">
<p>The map screen is built using a <strong>MKMapView</strong>. The restaurant is displayed using <strong>MKMarkerAnnotationView</strong> that displays a balloon-shaped maker at the designated location.</p>
<p>The data use in this project is dummy data from <a href="https://my-json-server.typicode.com/quanrong88/Demo-repo" target="_blank" rel="noopener">this api</a>. After fetching from server, data will be saved to local disk by using <strong>Core data</strong> then bind to UI</p>
<p>The aims of this part are to load data from api, save it into data and bind to UI.</p>
<h3 id="Introducing-DummyMap"><a href="#Introducing-DummyMap" class="headerlink" title="Introducing DummyMap"></a>Introducing DummyMap</h3><p>In the rest of this article, you are going to create cool location-based app called <strong>DummyMap</strong>. It will allow you to find variant of restaurants in Ha Noi by showing list of restaurant and location of them on map.</p>
<p>Let’s start. Open Xcode and go to <strong>File\New\Project…</strong> and select <strong>iOS\Application\Single View Application</strong> template.</p>
<img src="/2017/12/19/My-simple-location-based-application/creating-single-view-app.png" title="Creating single view app">
<p>This temple will provide you with a single UIViewController and storyboard to start out with.</p>
<p>Click <strong>Next</strong> to fill out the information about the application. Set the Product Name to <strong>DummyMap</strong>, tick <strong>Use Core Data</strong> and language to <strong>Swift</strong>. Click <strong>Next</strong> to select the project location and then click <strong>Create</strong></p>
<img src="/2017/12/19/My-simple-location-based-application/enter-app-name.png" title="Fill out app name">
<p>The view controller subclass and storyboard that come with the single view application template aren’t any use to you. You’re going to use <strong>UITabBarViewController</strong> to be main view. Delete <strong>ViewController.swift</strong> and remove empty view controller from <strong>Main.storyboard</strong>. Now you’re got a blank state .</p>
<h3 id="Starting-your-feeds-screen"><a href="#Starting-your-feeds-screen" class="headerlink" title="Starting your feeds screen"></a>Starting your feeds screen</h3><p>Open <strong>Main.storyboard</strong> and drag in a Tabbar View Controller. Now you have a UITabBarViewController and 2 view controllers scene. Select item 1 Scene in storyboard, go to <strong>Editor\Embed in\Navigation Controller</strong> to create a navigation controller and automatically set the view controller as the root.</p>
<p>You should now have a layout like this in the storyboard:</p>
<img src="/2017/12/19/My-simple-location-based-application/init-layout-1.png" title="Init layout for feeds scene">
<p>Next, select the <strong>Tabbar Controller</strong> you installed and make it the initial view controller in the <strong>Attributes Inspector</strong>:</p>
<img src="/2017/12/19/My-simple-location-based-application/tabbar-become-init-scene.png" title="Init scene">
<p>Drag in a collection view to the item 1 scene and set constraint for it. This will be where the list of restaurants are going to be shown.</p>
 <img src="/2017/12/19/My-simple-location-based-application/list-collectionview.png" title="Collection view for restaurants">
<p>Go to <strong>File\New\File…</strong>, choose <strong>iOS\Source\Cocoa Touch Class</strong> template and click <strong>Next</strong>. Name the new class <strong>FeedVC.swift</strong>, making it a subclass of <strong>UIViewController</strong>. The template provides you some basic function, you will add more code to implement <strong>UICollectionViewDelegate*, </strong>UICollectionViewDataSource<strong>, </strong>UICollectionViewDelegateFlowLayout**.</p>
<p>Go back to <strong>Main.storyboard</strong>, select the view controller scene item 1 and in the identity inspector, set <strong>Class</strong> to <strong>FeedVC.swift</strong> to mach your new class.</p>
<img src="/2017/12/19/My-simple-location-based-application/setup-feedVC-class.png" title="Set up FeedVC class">
<p>Next, control-drag from the collection view to the view controller and choose <strong>delegate</strong> and <strong>data source</strong> outlet:</p>
<img src="/2017/12/19/My-simple-location-based-application/set-collectionview-delegate-and-datasource.png" title="Set collection view delegate and data source">
<p>Finally, select <strong>Collection View Flow Layout</strong> object in the collection view and in size inspector set the <strong>Min Spacing</strong> to 0 <strong>For Cells</strong> , 0 <strong>For Lines</strong>.</p>
<img src="/2017/12/19/My-simple-location-based-application/setup-collectionviewlayout.png" title="Set up collection view flow layout object">
<h3 id="Getting-Dummy-Restaurants"><a href="#Getting-Dummy-Restaurants" class="headerlink" title="Getting Dummy Restaurants"></a>Getting Dummy Restaurants</h3><p><a href="https://my-json-server.typicode.com" target="_blank" rel="noopener">My JSON Server</a> is a website allow you to create static json contents. It’s good for test projects like this and very easy to use.</p>
<p>In this project, you will use <a href="https://github.com/Alamofire/Alamofire" target="_blank" rel="noopener">Alamofire</a> library to fetch api. It is an HTTP networking library written in Swift.</p>
<p>Now, open <strong>FeedVC.swift</strong> and add following code to declare the url to fetch json data and import Alamofire library :</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> Alamofire</span><br><span class="line"><span class="keyword">let</span> mainURL = <span class="string">"https://my-json-server.typicode.com/quanrong88/Demo-repo/shops"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedVC</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Code here ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Next, add <strong>getRestaurantList()</strong> method to call Alamofire load json data from main url.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getRestaurantList</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="type">Alamofire</span>.request(mainURL).responseJSON &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] response <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">switch</span> response.result &#123;</span><br><span class="line">            <span class="keyword">case</span> .success:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Validation Successful"</span>)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"json data <span class="subst">\(response.result.value)</span>"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> .failure(<span class="keyword">let</span> error):</span><br><span class="line">                <span class="built_in">print</span>(error)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Try to load by placing <strong>getRestaurantList()</strong> in <strong>viewDidLoad()</strong> template method, if you see the log success and json data , that mean you’ve completed this step and now ready to move on.</p>
<h3 id="Modeling-your-data"><a href="#Modeling-your-data" class="headerlink" title="Modeling your data"></a>Modeling your data</h3><p>Up to this point, you’ve been able to load json data, it’s time to save data into disk. In this section, you’ll covert json data into Core data objects.</p>
<p>The first step is to create a <strong>managed object model</strong>, which describes the way Core Data represents data on disk.</p>
<p>By default, Core Data uses a SQLite database as the persistent store, so you can think of the Data Model as the database schema.</p>
<p>Since you’ve elected to use Core Data, Xcode automatically created a Data Model file for you and named it <strong>DummyMap.xcdatamodeld</strong>.</p>
<img src="/2017/12/19/My-simple-location-based-application/xcdatamodel-file.png" title="xcdatamodel file">
<p>Open <strong>DummyMap.xcdatamodeld</strong>, click on <strong>Add Entity</strong> on the lower-left to create a new entity. Double-click the new entity and changes its name to <strong>Restaurant</strong>, like so:</p>
<img src="/2017/12/19/My-simple-location-based-application/blank-restaurant-model.png" title="Blank restaurant model">
<p>Next, select <strong>Restaurant</strong> on the left-hand side and click the plus sign (+) under <strong>Attributes</strong>. Set some new attributes like this :</p>
<img src="/2017/12/19/My-simple-location-based-application/full-restaurant-model.png" title="Full restaurant model">
<h3 id="Setting-up-Core-Data-Stack"><a href="#Setting-up-Core-Data-Stack" class="headerlink" title="Setting up Core Data Stack"></a>Setting up Core Data Stack</h3><p>The view controller template already provides you default <strong>Core Data Stack</strong> code in <strong>AppDelegate.swift</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MARK: - Core Data stack</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> persistentContainer: <span class="type">NSPersistentContainer</span> = &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         The persistent container for the application. This implementation</span></span><br><span class="line"><span class="comment">         creates and returns a container, having loaded the store for the</span></span><br><span class="line"><span class="comment">         application to it. This property is optional since there are legitimate</span></span><br><span class="line"><span class="comment">         error conditions that could cause the creation of the store to fail.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">let</span> container = <span class="type">NSPersistentContainer</span>(name: <span class="string">"DummyMap"</span>)</span><br><span class="line">        container.loadPersistentStores(completionHandler: &#123; (storeDescription, error) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> error = error <span class="keyword">as</span> <span class="type">NSError</span>? &#123;</span><br><span class="line">                <span class="comment">// Replace this implementation with code to handle the error appropriately.</span></span><br><span class="line">                <span class="comment">// fatalError() causes the application to generate a crash log and terminate. You should not use this function in a shipping application, although it may be useful during development.</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 Typical reasons for an error here include:</span></span><br><span class="line"><span class="comment">                 * The parent directory does not exist, cannot be created, or disallows writing.</span></span><br><span class="line"><span class="comment">                 * The persistent store is not accessible, due to permissions or data protection when the device is locked.</span></span><br><span class="line"><span class="comment">                 * The device is out of space.</span></span><br><span class="line"><span class="comment">                 * The store could not be migrated to the current model version.</span></span><br><span class="line"><span class="comment">                 Check the error message to determine what the actual problem was.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                <span class="built_in">fatalError</span>(<span class="string">"Unresolved error <span class="subst">\(error)</span>, <span class="subst">\(error.userInfo)</span>"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> container</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - Core Data Saving support</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">saveContext</span> <span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> context = persistentContainer.viewContext</span><br><span class="line">        <span class="keyword">if</span> context.hasChanges &#123;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> context.save()</span><br><span class="line">            &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                <span class="comment">// Replace this implementation with code to handle the error appropriately.</span></span><br><span class="line">                <span class="comment">// fatalError() causes the application to generate a crash log and terminate. You should not use this function in a shipping application, although it may be useful during development.</span></span><br><span class="line">                <span class="keyword">let</span> nserror = error <span class="keyword">as</span> <span class="type">NSError</span></span><br><span class="line">                <span class="built_in">fatalError</span>(<span class="string">"Unresolved error <span class="subst">\(nserror)</span>, <span class="subst">\(nserror.userInfo)</span>"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>In order to reuse code and separate Core Data code with app delegate, you’re going to create a new class named <strong>CoreDataStack</strong></p>
<p>Go to <strong>File\New\File…</strong>, select <strong>iOS\Source\Swift File</strong> template and click <strong>Next</strong>. Name the file <strong>CoreDataStack</strong> and click <strong>Create</strong> to save the file.</p>
<p>Clean up the default Core data stack in <strong>AppDelegate.swift</strong> and go to the newly created <strong>CoreDataStack.swift</strong>. Start by replacing the contents of the file with the following:<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> CoreData</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CoreDataStack</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">let</span> modelName: <span class="type">String</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(modelName: <span class="type">String</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.modelName = modelName</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">lazy</span> <span class="keyword">var</span> managedContext: <span class="type">NSManagedObjectContext</span> = &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.storeContainer.viewContext</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">lazy</span> <span class="keyword">var</span> storeContainer: <span class="type">NSPersistentContainer</span> = &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> container = <span class="type">NSPersistentContainer</span>(name: <span class="keyword">self</span>.modelName)</span><br><span class="line">        container.loadPersistentStores &#123; (storeDescription, error) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> error = error <span class="keyword">as</span> <span class="type">NSError</span>? &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Unresolved error <span class="subst">\(error)</span>, <span class="subst">\(error.userInfo)</span>"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> container</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">saveContext</span> <span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> managedContext.hasChanges <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> managedContext.save()</span><br><span class="line">        &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Unresolved error <span class="subst">\(error)</span>, <span class="subst">\(error.userInfo)</span>"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Next, open <strong>AppDelegate.swift</strong>, below window, add a propery to hold the Core Data stack:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> coreDataStack = <span class="type">CoreDataStack</span>(modelName: <span class="string">"DummyMap"</span>)</span><br></pre></td></tr></table></figure>
<p>You initialize the Core Data stack object as a lazy variable on the application delegate. This mean the stack won’t be set up until the first time you access the property.</p>
<p>Still in <strong>AppDelegate.swift</strong>, replace applicationDidEnterBackground(<em> application: UIApplication) and applicationWillTerminate(</em> application: UIApplication) with the following:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">applicationDidEnterBackground</span><span class="params">(<span class="number">_</span> application: UIApplication)</span></span> &#123;</span><br><span class="line">    coreDataStack.saveContext()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">applicationWillTerminate</span><span class="params">(<span class="number">_</span> application: UIApplication)</span></span> &#123;</span><br><span class="line">    coreDataStack.saveContext()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Adding-managed-object-subclasses"><a href="#Adding-managed-object-subclasses" class="headerlink" title="Adding managed object subclasses"></a>Adding managed object subclasses</h3><p>Go to <strong>Editor\Create NSManagedObject Subclass…</strong> and choose the <strong>DummyMap</strong> model, and <strong>Restaurant</strong> entity. Click <strong>Create</strong> on the next screen to create the files.</p>
<p>Xcode generated 2 Swift files for you, one called <strong>Restaurant+CoreDataClass.swift</strong> and a second called <strong>Restaurant+CoreDataProperties.swift</strong>.</p>
<p>Open <strong>Restaurant+CoreDataClass.swift</strong>. It should look like this:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> CoreData</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Restaurant</span>: <span class="title">NSManagedObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Next, open <strong>Restaurant+CoreDataProperties.swift</strong>. It should look like this:<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> CoreData</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Restaurant</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@nonobjc</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">fetchRequest</span>() -&gt; <span class="title">NSFetchRequest</span>&lt;<span class="title">Restaurant</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">NSFetchRequest</span>&lt;<span class="type">Restaurant</span>&gt;(entityName: <span class="string">"Restaurant"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NSManaged</span> <span class="keyword">public</span> <span class="keyword">var</span> id: <span class="type">String</span>?</span><br><span class="line">    <span class="meta">@NSManaged</span> <span class="keyword">public</span> <span class="keyword">var</span> name: <span class="type">String</span>?</span><br><span class="line">    <span class="meta">@NSManaged</span> <span class="keyword">public</span> <span class="keyword">var</span> bio: <span class="type">String</span>?</span><br><span class="line">    <span class="meta">@NSManaged</span> <span class="keyword">public</span> <span class="keyword">var</span> type: <span class="type">String</span>?</span><br><span class="line">    <span class="meta">@NSManaged</span> <span class="keyword">public</span> <span class="keyword">var</span> rate: <span class="type">Double</span></span><br><span class="line">    <span class="meta">@NSManaged</span> <span class="keyword">public</span> <span class="keyword">var</span> latitude: <span class="type">Double</span></span><br><span class="line">    <span class="meta">@NSManaged</span> <span class="keyword">public</span> <span class="keyword">var</span> longitude: <span class="type">Double</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Saving-into-Core-data"><a href="#Saving-into-Core-data" class="headerlink" title="Saving into Core data"></a>Saving into Core data</h3><p>Open <strong>FeedVC.swift</strong> and add following below import UIKit</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> CoreData</span><br></pre></td></tr></table></figure>
<p>Next, add the following below the last IBOutlet property</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> managedContext: <span class="type">NSManagedObjectContext</span>!</span><br></pre></td></tr></table></figure>
<p>Set the <strong>managedContext</strong> property in <strong>viewDidLoad()</strong>. Add the following below the super call</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> appDelegate = <span class="type">UIApplication</span>.shared.delegate <span class="keyword">as</span>! <span class="type">AppDelegate</span></span><br><span class="line">managedContext = appDelegate.coreDataStack.managedContext</span><br></pre></td></tr></table></figure>
<p>In previous section, you’ve been able to download json data from Api. The json data is an array of dictionaries. You will start saving process by converting a item dictionary to Core Data Object. Add following method to <strong>FeedVC.swift</strong></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertNewShopEntity</span><span class="params">(dict: [String:Any])</span></span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> entity = <span class="type">NSEntityDescription</span>.entity(forEntityName: <span class="string">"Restaurant"</span>,</span><br><span class="line">                                                      <span class="keyword">in</span>: managedContext) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="keyword">let</span> restaurant = <span class="type">Restaurant</span>(entity: entity, insertInto: managedContext)</span><br><span class="line">        restaurant.id = dict[<span class="string">"id"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">        restaurant.name = dict[<span class="string">"name"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">        restaurant.bio = dict[<span class="string">"bio"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">        restaurant.type = dict[<span class="string">"type"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">        restaurant.rate = dict[<span class="string">"rate"</span>] <span class="keyword">as</span>? <span class="type">Double</span> ?? <span class="number">0</span></span><br><span class="line">        restaurant.latitude = dict[<span class="string">"latitude"</span>] <span class="keyword">as</span>? <span class="type">Double</span> ?? <span class="number">0</span></span><br><span class="line">        restaurant.longitude = dict[<span class="string">"longitude"</span>] <span class="keyword">as</span>? <span class="type">Double</span> ?? <span class="number">0</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Next, iterate all json array to save data into Core Data by adding following</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseJsonData</span><span class="params">(input: [[String:Any]])</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> dict <span class="keyword">in</span> input &#123;</span><br><span class="line">            insertNewShopEntity(dict: dict)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>! managedContext.save()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Now, you are able to parse json data into Core Data. It’s time to add this method to Api caller . Your Api call should look like this</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getRestaurantList</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="type">Alamofire</span>.request(mainURL).responseJSON &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] response <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">switch</span> response.result &#123;</span><br><span class="line">            <span class="keyword">case</span> .success:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Validation Successful"</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> json = response.result.value <span class="keyword">as</span>? [[<span class="type">String</span>:<span class="type">Any</span>]] &#123;</span><br><span class="line">                    <span class="keyword">self</span>.parseJsonData(input: json)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> .failure(<span class="keyword">let</span> error):</span><br><span class="line">                <span class="built_in">print</span>(error)</span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The final step is fetching data from Core Data. Firstly, add <strong>feedData</strong> property below <strong>managedContext</strong> property.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> feedData: [<span class="type">Restaurant</span>] = []</span><br></pre></td></tr></table></figure>
<p>Secondly, make a fetch request to get data from Core Data and save it into <strong>feedData</strong> property by adding following method</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fetchRestaurantList</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> request = <span class="type">NSFetchRequest</span>&lt;<span class="type">Restaurant</span>&gt;(entityName: <span class="string">"Restaurant"</span>)</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> results = <span class="keyword">try</span> managedContext.fetch(request)</span><br><span class="line">            feedData = results</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Feed data <span class="subst">\(feedData)</span>"</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Could not fetch <span class="subst">\(error)</span>, <span class="subst">\(error.userInfo)</span>"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Place <strong>fetchRestaurantList()</strong> in <strong>viewDidLoad()</strong> and restart app. If you can see the log data, you are complete this section.</p>
<h3 id="Feeding-the-UICollectionView"><a href="#Feeding-the-UICollectionView" class="headerlink" title="Feeding the UICollectionView"></a>Feeding the UICollectionView</h3><p>Similar to table view, when you use a collection view you have to set a data source and a delegate as well. Their roles are the following:</p>
<ul>
<li>The data source (<strong>UICollectionViewDataSource</strong>) returns information about the number of items in the collection view and their views.</li>
<li>The delegate (<strong>UICollectionViewDelegate</strong>) is notified when events happen such as cells being selected, highlighted, or removed.</li>
<li>The flow layout object delegate (<strong>UICollectionViewDelegateFlowLayout</strong>) allows you to tweak the behaviour of the layout, configuring things like the cell spacing, scroll direction, and more.</li>
</ul>
<p>In this section, you’re going to implement the required <strong>UICollectionViewDataSource</strong> and <strong>UICollectionViewDelegateFlowLayout</strong> methods on your view controller.</p>
<h3 id="UICollectionViewDataSource"><a href="#UICollectionViewDataSource" class="headerlink" title="UICollectionViewDataSource"></a>UICollectionViewDataSource</h3><p>Firstly, add a <strong>UICollectionViewCell</strong> subclass to present restaurant data. Go to <strong>File\New\File…</strong>, choose <strong>iOS\Source\Cocoa Touch Class</strong> template and click <strong>Next</strong>. Name the new class <strong>DemoCell.swift</strong>, making it a subclass of <strong>UICollectionViewCell</strong>, check <strong>Also create XIB file</strong> and then click <strong>Next</strong>.</p>
<img src="/2017/12/19/My-simple-location-based-application/add-collection-cell-class.png" title="Add collection view class">
<p>Open <strong>DemoCell.xib</strong>, drag-drop following control to collection view cell interface builder interface</p>
<img src="/2017/12/19/My-simple-location-based-application/config-democell.png" title="Config of demo cell">
<p>These controls are pretty straightforward:</p>
<ol>
<li><strong>Type icon</strong> is a <strong>UIImageView</strong>. It show the type icon for each restaurant and has fix size 40x40.</li>
<li><strong>Title Lbl</strong> is a <strong>UILabel</strong>. It show the restaurant’s name.</li>
<li>A view with height 1. It’s separate line between lines in collection view.</li>
<li>A button with fix size 24x24. It works like indicator view in table view.</li>
<li><strong>Rate view</strong> is subclass of <a href="https://github.com/evgenyneu/Cosmos" target="_blank" rel="noopener">CosmosView</a>. It’s a star rating control lib written in Swift.</li>
</ol>
<p>Open <strong>DemoCell.swift</strong> , control-drag outlet to this file and add following methods. Your <strong>DemoCell.swift</strong> should look like this:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> Cosmos</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoCell</span>: <span class="title">UICollectionViewCell</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> typeIcon: <span class="type">UIImageView</span>!</span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> titleLbl: <span class="type">UILabel</span>!</span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> rateView: <span class="type">CosmosView</span>!</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> identifier: <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">String</span>(describing: <span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">var</span> nib: <span class="type">UINib</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">UINib</span>(nibName: identifier, bundle: <span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">awakeFromNib</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.awakeFromNib()</span><br><span class="line">        <span class="comment">// Initialization code</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">moreInfoBtnClicked</span><span class="params">(<span class="number">_</span> sender: UIButton)</span></span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Show more info"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">setTypeIcon</span><span class="params">(type: String)</span></span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> type &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"hawk"</span>:</span><br><span class="line">            typeIcon.image = #imageLiteral(resourceName: <span class="string">"bakery"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"coffee"</span>:</span><br><span class="line">            typeIcon.image = #imageLiteral(resourceName: <span class="string">"coffee"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"fastfood"</span>:</span><br><span class="line">            typeIcon.image = #imageLiteral(resourceName: <span class="string">"fastfood"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">"streettea"</span>:</span><br><span class="line">            typeIcon.image = #imageLiteral(resourceName: <span class="string">"water"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            typeIcon.image = #imageLiteral(resourceName: <span class="string">"food-icon"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Open <strong>FeedVC.swift</strong>, add the following code into <strong>viewDidLoad()</strong> to register the new collection view cell:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feedCollectionView.register(<span class="type">DemoCell</span>.nib, forCellWithReuseIdentifier: <span class="type">DemoCell</span>.identifier)</span><br></pre></td></tr></table></figure>
<p>Next, add the following extension to the file for the <strong>UICollectionViewDataSource</strong> protocol:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">FeedVC</span>: <span class="title">UICollectionViewDataSource</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, numberOfItemsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> feedData.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, cellForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = collectionView.dequeueReusableCell(withReuseIdentifier: <span class="type">DemoCell</span>.identifier, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">DemoCell</span></span><br><span class="line">        <span class="keyword">let</span> restaurant = feedData[indexPath.row]</span><br><span class="line">        cell.titleLbl.text = restaurant.name</span><br><span class="line">        cell.rateView.rating = restaurant.rate</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> type = restaurant.type &#123;</span><br><span class="line">            cell.setTypeIcon(type: type)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">numberOfSections</span><span class="params">(<span class="keyword">in</span> collectionView: UICollectionView)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="UICollectionViewDelegateFlowLayout"><a href="#UICollectionViewDelegateFlowLayout" class="headerlink" title="UICollectionViewDelegateFlowLayout"></a>UICollectionViewDelegateFlowLayout</h3><p>In this project, the collection view layout will be changed depend on device’s orientation. Most of layout parameters have been configured in storyboard, only size of item is depend on device’s width. Add the <strong>UICollectionViewDelegateFlowLayout</strong> extension to allow the view controller to conform to the flow layout delegate protocol:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">FeedVC</span>: <span class="title">UICollectionViewDelegateFlowLayout</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, layout collectionViewLayout: UICollectionViewLayout, sizeForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">CGSize</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="type">UIDevice</span>.current.orientation &#123;</span><br><span class="line">        <span class="keyword">case</span> .landscapeLeft, .landscapeRight:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">CGSize</span>(width: collectionView.bounds.size.width / <span class="number">3</span> , height: <span class="number">150</span>)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">CGSize</span>(width: collectionView.bounds.size.width, height: <span class="number">60</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This method is pretty straightforward. In portrait mode, the collection view cell has width equal to screen’s width, and in landscape mode, the collection view will show 3 cells per row with the grid-view style.</p>
<p>Add, following code under set <strong>feedData</strong> line in <strong>fetchRestaurantList()</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feedCollectionView.reloadData()</span><br></pre></td></tr></table></figure>
<p>Then, add <strong>fetchRestaurantList()</strong> to the end of <strong>parseJsonData(input: [[String:Any]])</strong> to automatically load data when paring data successful. Add following method to <strong>FeedVC</strong> class to invalid layout when device rotate:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillTransition</span><span class="params">(to size: CGSize, with coordinator: UIViewControllerTransitionCoordinator)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewWillTransition(to: size, with: coordinator)</span><br><span class="line">        feedCollectionView.collectionViewLayout.invalidateLayout()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Build and run project, you should see the result like this:</p>
<img src="/2017/12/19/My-simple-location-based-application/feeds-portrait-mode.png" title="Feeds screen on portrait">
<p><em>Feeds screen on portrait mode</em><br><img src="/2017/12/19/My-simple-location-based-application/feeds-landscape-mode.png" title="Feeds screen on landscape"><br><em>Feeds screen on landscape mode</em></p>
<h3 id="Detail-Restaurant-Screen"><a href="#Detail-Restaurant-Screen" class="headerlink" title="Detail Restaurant Screen"></a>Detail Restaurant Screen</h3><p>To complete the Feed tab, you’re going to add the final piece of Feed tab. Go to <strong>File\New\File…</strong>, choose <strong>iOS\Source\Cocoa Touch Class</strong> template and click <strong>Next</strong>. Name the new class <strong>RestaurantDetailVC.swift</strong>, making it a subclass of <strong>UIViewController</strong>. Then open <strong>Main.storyboard</strong>, from <strong>Object library</strong> drag-drop a <em>View Controller</em> object to storyboard and open <strong>Identify inspector</strong> set <strong>Custom class</strong> to <strong>RestaurantDetailVC</strong>. Open <strong>RestaurantDetailVC.swift</strong> and add following to class:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> Cosmos</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestaurantDetailVC</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> bioTextView: <span class="type">UITextView</span>!</span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> nameLbl: <span class="type">UILabel</span>!</span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> ratingView: <span class="type">CosmosView</span>!</span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> bgImg: <span class="type">UIImageView</span>!</span><br><span class="line">    <span class="keyword">var</span> restaurant: <span class="type">Restaurant</span>?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> input = restaurant &#123;</span><br><span class="line">            bindingUI(input: input)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didReceiveMemoryWarning</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.didReceiveMemoryWarning()</span><br><span class="line">        <span class="comment">// Dispose of any resources that can be recreated.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// MARK: Ultilities function</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">bindingUI</span><span class="params">(input: Restaurant)</span></span> &#123;</span><br><span class="line">        nameLbl.text = input.name</span><br><span class="line">        ratingView.rating = input.rate</span><br><span class="line">        bioTextView.text = input.bio</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> type = input.type &#123;</span><br><span class="line">            <span class="keyword">switch</span> type &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"hawk"</span>:</span><br><span class="line">                bgImg.image = #imageLiteral(resourceName: <span class="string">"hawk-bg"</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">"coffee"</span>:</span><br><span class="line">                bgImg.image = #imageLiteral(resourceName: <span class="string">"coffee-bg"</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">"fastfood"</span>:</span><br><span class="line">                bgImg.image = #imageLiteral(resourceName: <span class="string">"fastfood-bg"</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">case</span> <span class="string">"streettea"</span>:</span><br><span class="line">                bgImg.image = #imageLiteral(resourceName: <span class="string">"streettea-bg"</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Next, prepare the view structure like following in storyboard:</p>
<img src="/2017/12/19/My-simple-location-based-application/detail-view-structure.png" title="Detail restaurant view structure">
<p>The view in storyboard should look like this:</p>
<img src="/2017/12/19/My-simple-location-based-application/complete-detail-view.png" title="Complete restaurant detail view in storyboard">
<p>Next, control-drag from <strong>FeedVC</strong> scene to <strong>RestaurantDetailVC</strong> scene to create a segue. Select this segue and open <strong>Attributes inspector</strong> set <strong>Identifier</strong> to <em>showDetail</em>. Open <strong>FeedVC.swift</strong> and add following extension to class for opening <strong>RestaurantDetailVC</strong> scene when you select collectionview cell:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">FeedVC</span>: <span class="title">UICollectionViewDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> restaurant = feedData[indexPath.row]</span><br><span class="line">        performSegue(withIdentifier: <span class="string">"showDetail"</span>, sender: restaurant)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You get the restaurant’s data by index path and pass it into <em>sender</em> parameter. Then , you add the following method to class to finish</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(<span class="keyword">for</span> segue: UIStoryboardSegue, sender: Any?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> segue.identifier == <span class="string">"showDetail"</span>, <span class="keyword">let</span> desVC = segue.destination <span class="keyword">as</span>? <span class="type">RestaurantDetailVC</span>, <span class="keyword">let</span> content = sender <span class="keyword">as</span>? <span class="type">Restaurant</span> &#123;</span><br><span class="line">            desVC.restaurant = content</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Buid and run project, try to tap 1 collectionview cell. It should push <strong>RestaurantDetailVC</strong> scene. Now you have completed the first tab of this application, it’s time to move on second tab.</p>
<h3 id="Starting-your-Map-screen"><a href="#Starting-your-Map-screen" class="headerlink" title="Starting your Map screen"></a>Starting your Map screen</h3><p>In this project, <strong>MapKit</strong> is going to be used to display maps, plot locations of restaurants. Now let’s get start.</p>
<p>Open <strong>Main.storyboard</strong>, select <strong>item 2</strong> view controller of main tabbar controller. From the <strong>Object library</strong>, drag a <strong>MapKit View</strong> into the scene and add constraints for it:</p>
<img src="/2017/12/19/My-simple-location-based-application/mapKit-config.png" title="Configure Mapkit">
<p>Go to <strong>File\New\File…</strong>, choose <strong>iOS\Source\Cocoa Touch Class</strong> template and click <strong>Next</strong>. Name the new class <strong>MapVC.swift</strong>, making it a subclass of <strong>UIViewController</strong>. Set <strong>item 2</strong> scene <strong>Custom class</strong> to <strong>MapVC</strong> in <strong>Identify inspector</strong>.</p>
<img src="/2017/12/19/My-simple-location-based-application/set-mapVC-class.png" title="Set custom class MapVC">
<p>Next, add this line to <strong>MapVC.swift</strong>, just below the import UIKit statement:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> MapKit</span><br></pre></td></tr></table></figure>
<p>Build and run your project, you’ll have a fully zoomable and pannable map showing the continent of your current location, using Apple Maps.</p>
<p>To control the map view, you must create an <em>outlet</em> for it in <strong>MapVC.swift</strong>.</p>
<p>In the storyboard, open the <strong>assistant editor</strong>. It should display <strong>MapVC.swift</strong>.</p>
<p>To create the outlet, click the <strong>Map View</strong> in <strong>Main.storyboard</strong>, and control-drag from it into space just inside the <strong>MapVC.swift</strong>:</p>
<img src="/2017/12/19/My-simple-location-based-application/add-mapView-outlet.png" title="Add map view outlet">
<h3 id="Initialization-location"><a href="#Initialization-location" class="headerlink" title="Initialization location"></a>Initialization location</h3><p>The dummy data return from API are some fake locations around Hoan Kiem Lake, Ha Noi, Viet Nam. So open <strong>MapVC.swift</strong>, add following below the map view <em>outlet*</em>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> initialLocation = <span class="type">CLLocation</span>(latitude: <span class="number">21.033333</span>, longitude: <span class="number">105.849998</span>)</span><br></pre></td></tr></table></figure>
<p>You’ll use this to set the starting coordinates of the map view to a point in Hoan Kiem Lake.</p>
<p>When telling the map what to display, giving a latitude and longitude is enough to center the map, but you must also specify the rectangular region to display, to get a correct zoom level.</p>
<p>Add the following constraint below the <strong>initialLocation</strong> declare:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> regionRadius: <span class="type">CLLocationDistance</span> = <span class="number">1000</span></span><br></pre></td></tr></table></figure>
<p>Next, add helper method to the class and place it into <strong>viewDidLoad()</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">centerMapOnLocation</span><span class="params">(location: CLLocation)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> coordinateRegion = <span class="type">MKCoordinateRegionMakeWithDistance</span>(location.coordinate,</span><br><span class="line">                                                                  regionRadius, regionRadius)</span><br><span class="line">        mapView.setRegion(coordinateRegion, animated: <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Build and run the app, you’ll see the Hoan Kiem Lake.</p>
<img src="/2017/12/19/My-simple-location-based-application/blank-map.png" title="Blank map">
<h3 id="The-Map-Annotation-Class"><a href="#The-Map-Annotation-Class" class="headerlink" title="The Map Annotation Class"></a>The Map Annotation Class</h3><p>First, create an  <strong>MapAnnotation</strong> class. Go to <strong>File\New\File</strong>, choose <strong>iOS\Source\Swift File</strong>, and click <strong>Next</strong>. Set the <strong>Save As</strong> field to <strong>MapAnnotation.swift</strong> and click <strong>Next</strong>.</p>
<p>Open <strong>MapAnnotation.swift</strong> in the editor and add the following:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> MapKit</span><br><span class="line"><span class="keyword">import</span> Contacts</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MapAnnotation</span>: <span class="title">NSObject</span>, <span class="title">MKAnnotation</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> title: <span class="type">String</span>?</span><br><span class="line">    <span class="keyword">let</span> subtitle: <span class="type">String</span>?</span><br><span class="line">    <span class="keyword">let</span> type: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> coordinate: <span class="type">CLLocationCoordinate2D</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(restaurant: <span class="type">Restaurant</span>) &#123;</span><br><span class="line">        title = restaurant.name</span><br><span class="line">        subtitle = restaurant.bio</span><br><span class="line">        type = restaurant.type ?? <span class="string">""</span></span><br><span class="line">        coordinate = <span class="type">CLLocationCoordinate2D</span>(latitude: restaurant.latitude, longitude: restaurant.longitude)</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> makerTintColor: <span class="type">UIColor</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> type &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"hawk"</span>:</span><br><span class="line">            <span class="keyword">return</span> .orange</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"coffee"</span>:</span><br><span class="line">            <span class="keyword">return</span> .brown</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"fastfood"</span>:</span><br><span class="line">            <span class="keyword">return</span> .yellow</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"streettea"</span>:</span><br><span class="line">            <span class="keyword">return</span> .green</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> .red</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> image: <span class="type">UIImage</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> type &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"hawk"</span>:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"bakery"</span>)</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"coffee"</span>:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"coffee"</span>)</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"fastfood"</span>:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"fastfood"</span>)</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"streettea"</span>:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"water"</span>)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"food-icon"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Annotation right callout accessory opens this mapItem in Maps app</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">mapItem</span><span class="params">()</span></span> -&gt; <span class="type">MKMapItem</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> addressDict = [<span class="type">CNPostalAddressStreetKey</span>: subtitle!]</span><br><span class="line">        <span class="keyword">let</span> placemark = <span class="type">MKPlacemark</span>(coordinate: coordinate, addressDictionary: addressDict)</span><br><span class="line">        <span class="keyword">let</span> mapItem = <span class="type">MKMapItem</span>(placemark: placemark)</span><br><span class="line">        mapItem.name = title</span><br><span class="line">        <span class="keyword">return</span> mapItem</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To adopt the <strong>MKAnnotation</strong> protocol, <strong>MapAnnotation</strong> must subclass <strong>NSObject</strong>, because <strong>MKAnnotation</strong> is an <strong>NSObjectProtocol</strong>.</p>
<p>The <strong>MKAnnotation</strong> protocol requires the <strong>coordinate</strong> property. 2 optical properties <strong>title</strong> and <strong>subtitle</strong> use to display name and description of the.</p>
<p>The <strong>type</strong> property determines type of the restaurant and from it you can get tint color and icon image via <strong>makerTintColor</strong> and <strong>image</strong> for each type of restaurants.</p>
<p>The <strong>mapItem()</strong> fuction returns a <strong>MKMapItem*</strong>. Here you create a <strong>MKMapItem</strong> from an <strong>MKPlacemark</strong>. The Maps app is able to read this <strong>MKMapItem</strong> and display the right thing. You will find out later in this tutorial.</p>
<h3 id="The-Map-Maker-View"><a href="#The-Map-Maker-View" class="headerlink" title="The Map Maker View"></a>The Map Maker View</h3><p>In this project, the restaurant will be displayed on map by a balloon-shaped maker at the designated location. With <strong>MKMarkerAnnotationView</strong>, you can complete this specification easily. Go to <strong>File\New\File</strong>, choose <strong>iOS\Source\Swift File</strong>, and click <strong>Next</strong>. Set the <strong>Save As</strong> field to <strong>MapMakerView.swift</strong> and click <strong>Next</strong>.</p>
<p>Open <strong>MapMakerView.swift</strong> in the editor and add the following:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> MapKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MapMakerView</span>: <span class="title">MKMarkerAnnotationView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">var</span> annotation: <span class="type">MKAnnotation</span>? &#123;</span><br><span class="line">        <span class="keyword">willSet</span> &#123;</span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> mapAnnotation = newValue <span class="keyword">as</span>? <span class="type">MapAnnotation</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            canShowCallout = <span class="literal">true</span></span><br><span class="line">            calloutOffset = <span class="type">CGPoint</span>(x: -<span class="number">5</span>, y: <span class="number">5</span>)</span><br><span class="line">            rightCalloutAccessoryView = <span class="type">UIButton</span>(type: .detailDisclosure)</span><br><span class="line">            markerTintColor = mapAnnotation.makerTintColor</span><br><span class="line">            glyphImage = mapAnnotation.image</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To configure the <strong>MKMarkerAnnotationView</strong>, you have to override setter of <strong>annotation</strong> property.</p>
<p>Finally, add the following method to register the <strong>MapMakerView</strong> view in <strong>viewDidLoad()</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mapView.register(<span class="type">MapMakerView</span>.<span class="keyword">self</span>, forAnnotationViewWithReuseIdentifier: <span class="type">MKMapViewDefaultAnnotationViewReuseIdentifier</span>)</span><br><span class="line">mapView.delegate = <span class="keyword">self</span></span><br></pre></td></tr></table></figure>
<p>Also, add this following extension to implementation map view delegate:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MapVC</span>: <span class="title">MKMapViewDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">mapView</span><span class="params">(<span class="number">_</span> mapView: MKMapView, annotationView view: MKAnnotationView,</span></span></span><br><span class="line"><span class="function"><span class="params">                 calloutAccessoryControlTapped control: UIControl)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> location = view.annotation <span class="keyword">as</span>! <span class="type">MapAnnotation</span></span><br><span class="line">        <span class="keyword">let</span> launchOptions = [<span class="type">MKLaunchOptionsDirectionsModeKey</span>:</span><br><span class="line">            <span class="type">MKLaunchOptionsDirectionsModeDriving</span>]</span><br><span class="line">        location.mapItem().openInMaps(launchOptions: launchOptions)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This method allows open the restaurant’s location on maps app.</p>
<h3 id="Parsing-Core-Data-object-into-MapAnnotation-object"><a href="#Parsing-Core-Data-object-into-MapAnnotation-object" class="headerlink" title="Parsing Core Data object into MapAnnotation object"></a>Parsing Core Data object into MapAnnotation object</h3><p>Now you have done setup view for show map annotation on the map, it’s time to parse the dataset into array of <strong>MapAnnotation</strong> objects. Then you’ll add them as annotations to the map view, to display all restaurants located in the current  map region.</p>
<p>Open <strong>MapVC.swift</strong>, add 2 following properties to the class to declare variable to store the <strong>MapAnnotation</strong> object and core data context:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> annotationList: [<span class="type">MapAnnotation</span>] = []</span><br><span class="line"><span class="keyword">var</span> managedContext: <span class="type">NSManagedObjectContext</span>!</span><br></pre></td></tr></table></figure>
<p>Next, add a fetch request to get the dataset from Core data then parsing them into array of <strong>MapAnnotation</strong> object. Add following helper method to class:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fetchAnnotation</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> request = <span class="type">NSFetchRequest</span>&lt;<span class="type">Restaurant</span>&gt;(entityName: <span class="string">"Restaurant"</span>)</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> results = <span class="keyword">try</span> managedContext.fetch(request)</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> results &#123;</span><br><span class="line">                <span class="keyword">let</span> annotation = <span class="type">MapAnnotation</span>(restaurant: item)</span><br><span class="line">                annotationList.append(annotation)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Could not fetch <span class="subst">\(error)</span>, <span class="subst">\(error.userInfo)</span>"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>Finally, add this code into <strong>viewWillAppear(_ animated: Bool)</strong> method:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> annotationList.isEmpty &#123;</span><br><span class="line">      fetchAnnotation()</span><br><span class="line">      mapView.addAnnotations(annotationList)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It will check if annotations list is empty, it’ll fetch data from Core Data and add the <strong>MapAnnotation</strong> to the map view. Build and run app, it should look like this:</p>
<img src="/2017/12/19/My-simple-location-based-application/full-map.png" title="Full map">
<h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>In this report, a simple location-based application has been completed. Now you know the basics of using <strong>Core Data</strong>, <strong>MapKit</strong>, <strong>Collection View</strong> to present and store data. Application can work smoothly now but we can do a lot of improvement to increase performance.</p>
<p>Here is the <a href="https://github.com/quanrong88/DummyMap/tree/part1" target="_blank" rel="noopener">final project</a> with all of the code you’re developed in this tutorial.</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-12-19</span><i class="fa fa-tag"></i><a href="/tags/Swift/" title="Swift" class="tag">Swift </a><a href="/tags/Core-Data/" title="Core Data" class="tag">Core Data </a><a href="/tags/Collection-View/" title="Collection View" class="tag">Collection View </a><a href="/tags/MapKit/" title="MapKit" class="tag">MapKit </a><a href="/tags/Dummy/" title="Dummy" class="tag">Dummy </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://quanrong88.github.io/2017/12/19/My-simple-location-based-application/,Tạ Quân,My simple location based application,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/" title="Refactoring code with MVVM in Swift 3" class="btn">prev post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>