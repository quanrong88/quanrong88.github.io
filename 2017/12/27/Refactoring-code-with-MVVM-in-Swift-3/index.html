<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Tạ Minh Quân,ta.quan@icloud.com"><title>Refactoring code with MVVM in Swift 3 · Tạ Quân</title><meta name="description" content="This article presents you how to apply the MVVM pattern in DummyMap application you have developed in previous tutorial. To do this, you’re going to r"><meta name="keywords" content="Hexo,Swift,Refactoring,iOS,Docker"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Tạ Quân</a></h3><div class="description"><p>Just make it simple.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/quanrong"><i class="fa fa-twitter"></i></a></li><li><a href="http://facebook.com/churongmayman"><i class="fa fa-facebook"></i></a></li><li><a href="http://github.com/quanrong88"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Archive</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"></a></li></div><div class="avatar"><img src="/images/blog_ava.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Refactoring code with MVVM in Swift 3</a></h3></div><div class="post-content"><p>This article presents you how to apply the MVVM pattern in <strong>DummyMap</strong> application you have developed in previous tutorial. To do this, you’re going to refactor the <strong>FeedVC</strong> class by using Facade pattern to hidden complexity of binding UI process and MVVM to help slim down the feed view controller by delegating some view controller’s tasks to a view model. Finally you will have new code easier to read and smoother binding process.</p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p><strong>MVVM</strong>(model-view-viewModel) is an architecture pattern that is an alternative to <strong>MVC</strong>(model-view-controller). The current version of <strong>FeedVC</strong> class is written in tradition <strong>MVC</strong> pattern, the image below illustrates the main components of the MVC pattern:</p>
<img src="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/mvc.png">
<p>This pattern separates the UI into the Model that represents the application state, the View, which in turn is composed of UI controls, and a Controller that handles user interactions and updates the model accordingly.</p>
<p>The problem with MVC in project is that it’s quite confusing. The networking, persistent, binding data code are all placed in view controller class cause massive code. MVVM, sometimes referred to as <a href="https://martinfowler.com/eaaDev/PresentationModel.html" target="_blank" rel="noopener">presentation model</a>, offers a way to organize code that solve these issues.</p>
<img src="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/mvvm.png">
<p>The core of this pattern is viewModel. This file holds the values to be presented in your view. The logic to format the values to be present is placed in the viewModel. In the context of current <strong>DummyMap</strong> app, it make a advantage that you can format a viewModel from multiple source of model. You will find out later in this article.</p>
<p>The relationships between the three components of the MVVM pattern are simpler than the MVC equivalents, following these strict rules:</p>
<ul>
<li>The View has a reference to the ViewModel, but not vice-versa.</li>
<li>The ViewModel has a reference to the Model, but not vice-versa.</li>
</ul>
<p>The aims of this part are to refactor feed tab with MVVM and move networking, persistent code to outside <strong>FeedVC</strong> class.</p>
<h3 id="Improve-loading-process"><a href="#Improve-loading-process" class="headerlink" title="Improve loading process"></a>Improve loading process</h3><p>Build and run <a href="https://github.com/quanrong88/DummyMap/tree/part1" target="_blank" rel="noopener">starter project</a>. You can see the problem with current loading process is that on the first launch, app is freezing and slow. The first launch, app have to load data from server and convert return json to Core Data object then present to UI. After first launch, app load data much faster because data is saved in Core Data, and app fetch data and present it. The following activity diagram show the current loading process:</p>
<img src="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/beginDiagram.png">
<p>To improve it, you’re going to use MVVM pattern. The improved process is presented in the following diagram:</p>
<img src="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/part2FinalDiagram.png">
<p>In new process, the json data will be convert to Data Model and parsing json to Core Data object will implement in background on the first launch. This process make data display much faster and app runs smoother than old one.</p>
<p>To archive this, you’re going to use <strong>Facade</strong> pattern to refactor <strong>FeedVC</strong> class. Facade pattern defines an simpler interface to an complex subsystem. You will divide <strong>FeedVC</strong> into some subsystems. The following sequence diagram will present how to use Facade pattern in this case:</p>
<img src="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/part2SequenceDiagram.png">
<ol>
<li><strong>FeedVC</strong> implements only view logic .</li>
<li><strong>DataManager</strong> is Facade class. It provides a interface to use another subsystems.</li>
<li><strong>ApiClient</strong> implements requesting server to get json data and parsing json to Core Data object.</li>
<li><strong>PersistenceManager</strong> implements Core Data tasks like parsing json, clean data, fetching.</li>
<li><strong>RestaurantDataModel</strong> stores restaurant’s information and will be use to create view model</li>
</ol>
<h3 id="PersistenceManager"><a href="#PersistenceManager" class="headerlink" title="PersistenceManager"></a>PersistenceManager</h3><p>First, you need to add new Data Model struct to hold the restaurant’s information. Go to <strong>File\New\File…</strong>, select <strong>iOS\Source\Swift File</strong> template and click <strong>Next</strong>. Name the file <strong>RestaurantDataModel</strong> and click <strong>Create</strong> to save the file. Add the following contents:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">RestaurantType</span>: <span class="title">String</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> hawk = <span class="string">"hawk"</span></span><br><span class="line">    <span class="keyword">case</span> coffee = <span class="string">"coffee"</span></span><br><span class="line">    <span class="keyword">case</span> fastfood = <span class="string">"fastfood"</span></span><br><span class="line">    <span class="keyword">case</span> streettea = <span class="string">"streettea"</span></span><br><span class="line">    <span class="keyword">case</span> na = <span class="string">"N/a"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RestaurantDataModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> bio: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> type: <span class="type">RestaurantType</span></span><br><span class="line">    <span class="keyword">var</span> rate: <span class="type">Double</span></span><br><span class="line">    <span class="keyword">var</span> latitude: <span class="type">Double</span></span><br><span class="line">    <span class="keyword">var</span> longitude: <span class="type">Double</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(restaurant: <span class="type">Restaurant</span>) &#123;</span><br><span class="line">        name = restaurant.name ?? <span class="string">""</span></span><br><span class="line">        bio = restaurant.bio ?? <span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> restaurantType = restaurant.type &#123;</span><br><span class="line">            type = <span class="type">RestaurantType</span>(rawValue: restaurantType) ?? .na</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; type = .na &#125;</span><br><span class="line">        rate = restaurant.rate</span><br><span class="line">        latitude = restaurant.latitude</span><br><span class="line">        longitude = restaurant.longitude</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(dict: [<span class="type">String</span>:<span class="type">Any</span>]) &#123;</span><br><span class="line">        name = dict[<span class="string">"name"</span>] <span class="keyword">as</span>? <span class="type">String</span> ?? <span class="string">""</span></span><br><span class="line">        bio = dict[<span class="string">"bio"</span>] <span class="keyword">as</span>? <span class="type">String</span> ?? <span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> restaurantType = dict[<span class="string">"type"</span>] <span class="keyword">as</span>? <span class="type">String</span> &#123;</span><br><span class="line">            type = <span class="type">RestaurantType</span>(rawValue: restaurantType) ?? .na</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; type = .na &#125;</span><br><span class="line">        rate = dict[<span class="string">"rate"</span>] <span class="keyword">as</span>? <span class="type">Double</span> ?? <span class="number">0</span></span><br><span class="line">        latitude = dict[<span class="string">"latitude"</span>] <span class="keyword">as</span>? <span class="type">Double</span> ?? <span class="number">0</span></span><br><span class="line">        longitude = dict[<span class="string">"longitude"</span>] <span class="keyword">as</span>? <span class="type">Double</span> ?? <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Next, Go to <strong>File\New\File…</strong>, select <strong>iOS\Source\Swift File</strong> template and click <strong>Next</strong>. Name the file <strong>PersistenceManager</strong> and click <strong>Create</strong> to save the file. Add the following contents:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> CoreData</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersistenceManager</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> coreDataStack = <span class="type">CoreDataStack</span>(modelName: <span class="string">"DummyMap"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">parseJsonData</span>(<span class="title">input</span>: [[<span class="title">String</span>:<span class="title">Any</span>]]) </span>&#123;</span><br><span class="line">        coreDataStack.storeContainer.performBackgroundTask &#123; (context) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">for</span> dict <span class="keyword">in</span> input &#123;</span><br><span class="line">                insertNewShopEntity(dict: dict, context: context)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span>! context.save()</span><br><span class="line">            coreDataStack.saveContext()</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">insertNewShopEntity</span>(<span class="title">dict</span>: [<span class="title">String</span>:<span class="title">Any</span>], <span class="title">context</span>: <span class="title">NSManagedObjectContext</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> entity = <span class="type">NSEntityDescription</span>.entity(forEntityName: <span class="string">"Restaurant"</span>,</span><br><span class="line">                                                      <span class="keyword">in</span>: context) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="keyword">let</span> restaurant = <span class="type">Restaurant</span>(entity: entity, insertInto: coreDataStack.managedContext)</span><br><span class="line">        restaurant.id = dict[<span class="string">"id"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">        restaurant.name = dict[<span class="string">"name"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">        restaurant.bio = dict[<span class="string">"bio"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">        restaurant.type = dict[<span class="string">"type"</span>] <span class="keyword">as</span>? <span class="type">String</span></span><br><span class="line">        restaurant.rate = dict[<span class="string">"rate"</span>] <span class="keyword">as</span>? <span class="type">Double</span> ?? <span class="number">0</span></span><br><span class="line">        restaurant.latitude = dict[<span class="string">"latitude"</span>] <span class="keyword">as</span>? <span class="type">Double</span> ?? <span class="number">0</span></span><br><span class="line">        restaurant.longitude = dict[<span class="string">"longitude"</span>] <span class="keyword">as</span>? <span class="type">Double</span> ?? <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">fetchRestaurantList</span>(<span class="title">completion</span>: @<span class="title">escaping</span> ([<span class="title">Restaurant</span>]) -&gt; <span class="title">Void</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> request = <span class="type">NSFetchRequest</span>&lt;<span class="type">Restaurant</span>&gt;(entityName: <span class="string">"Restaurant"</span>)</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> results = <span class="keyword">try</span> coreDataStack.managedContext.fetch(request)</span><br><span class="line">            completion(results)</span><br><span class="line">        &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">NSError</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Could not fetch <span class="subst">\(error)</span>, <span class="subst">\(error.userInfo)</span>"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">fetchRestaurantModelList</span>(<span class="title">completion</span>: @<span class="title">escaping</span> ([<span class="title">RestaurantDataModel</span>]) -&gt; <span class="title">Void</span>) </span>&#123;</span><br><span class="line">        fetchRestaurantList(completion: &#123; (restaurants ) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">var</span> result: [<span class="type">RestaurantDataModel</span>] = []</span><br><span class="line">            <span class="keyword">for</span> item <span class="keyword">in</span> restaurants &#123;</span><br><span class="line">                <span class="keyword">let</span> model = <span class="type">RestaurantDataModel</span>(restaurant: item)</span><br><span class="line">                result.append(model)</span><br><span class="line">            &#125;</span><br><span class="line">            completion(result)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">clearAllData</span>() </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> fetchRequest = <span class="type">NSFetchRequest</span>&lt;<span class="type">NSFetchRequestResult</span>&gt;(entityName: <span class="string">"Restaurant"</span>)</span><br><span class="line">        <span class="keyword">let</span> batchDeleteRequest = <span class="type">NSBatchDeleteRequest</span>(fetchRequest: fetchRequest)</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> coreDataStack.managedContext.execute(batchDeleteRequest)</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="comment">// Error Handling</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can realize they are the functions you use in <strong>FeedVC</strong> class. The <em>parseJsonData(input: [[String:Any]])</em> method has been add the following block:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">coreDataStack.storeContainer.performBackgroundTask &#123; (context) <span class="keyword">in</span></span><br><span class="line">  <span class="comment">// Code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The adding new Core data and saving is performed in background thread. It make sure UI is not freezing during the process like before.</p>
<p>The <em>class func fetchRestaurantModelList(completion: @escaping ([RestaurantDataModel]) -&gt; Void)</em> allows directly fetch and covert Core data object to Data Model.</p>
<h3 id="ApiClient"><a href="#ApiClient" class="headerlink" title="ApiClient"></a>ApiClient</h3><p>This class just implements request server to get Json data. Go to <strong>File\New\File…</strong>, select <strong>iOS\Source\Swift File</strong> template and click <strong>Next</strong>. Name the file <strong>ApiClient</strong> and click <strong>Create</strong> to save the file. Add the following contents:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> Alamofire</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> mainURL = <span class="string">"https://my-json-server.typicode.com/quanrong88/Demo-repo/shops"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ApiClient</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">getRestaurantList</span>(<span class="title">completion</span>: @<span class="title">escaping</span> ([<span class="title">RestaurantDataModel</span>]) -&gt; <span class="title">Void</span>) </span>&#123;</span><br><span class="line">        <span class="type">Alamofire</span>.request(mainURL).responseJSON &#123; response <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">switch</span> response.result &#123;</span><br><span class="line">            <span class="keyword">case</span> .success:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Validation Successful"</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> json = response.result.value <span class="keyword">as</span>? [[<span class="type">String</span>:<span class="type">Any</span>]] &#123;</span><br><span class="line">                    <span class="keyword">var</span> result: [<span class="type">RestaurantDataModel</span>] = []</span><br><span class="line">                    <span class="keyword">for</span> item <span class="keyword">in</span> json &#123;</span><br><span class="line">                        <span class="keyword">let</span> model = <span class="type">RestaurantDataModel</span>(dict: item)</span><br><span class="line">                        result.append(model)</span><br><span class="line">                    &#125;</span><br><span class="line">                    completion(result)</span><br><span class="line">                    <span class="type">PersistenceManager</span>.parseJsonData(input: json)</span><br><span class="line">                    <span class="type">UserDefaults</span>.standard.<span class="keyword">set</span>(<span class="literal">true</span>, forKey: <span class="string">"previouslyLaunched"</span>)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> .failure(<span class="keyword">let</span> error):</span><br><span class="line">                <span class="built_in">print</span>(error)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="DataManager"><a href="#DataManager" class="headerlink" title="DataManager"></a>DataManager</h3><p>This class is Facade class. It use to class 2 below subsystems. Go to <strong>File\New\File…</strong>, select <strong>iOS\Source\Swift File</strong> template and click <strong>Next</strong>. Name the file <strong>DataManager</strong> and click <strong>Create</strong> to save the file. Add the following contents:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> dataChangedNotificationName = <span class="type">NSNotification</span>.<span class="type">Name</span>(rawValue: <span class="string">"dataHasBeenReloaded"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataManager</span>: <span class="title">NSObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> dataSource: [<span class="type">RestaurantDataModel</span>] = []</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> shareInstance = <span class="type">DataManager</span>()</span><br><span class="line">    <span class="keyword">let</span> previouslyLaunched = <span class="type">UserDefaults</span>.standard.bool(forKey: <span class="string">"previouslyLaunched"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">loadData</span><span class="params">(completion: @escaping <span class="params">([RestaurantDataModel])</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> !previouslyLaunched &#123;</span><br><span class="line">            <span class="type">ApiClient</span>.getRestaurantList(completion: &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] (dataModels) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">self</span>.dataSource = dataModels</span><br><span class="line">                completion(dataModels)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">PersistenceManager</span>.fetchRestaurantModelList(completion: &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] (dataModels) <span class="keyword">in</span></span><br><span class="line">                <span class="keyword">self</span>.dataSource = dataModels</span><br><span class="line">                completion(dataModels)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">reloadData</span><span class="params">(completion: @escaping <span class="params">([RestaurantDataModel])</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="type">PersistenceManager</span>.clearAllData()</span><br><span class="line">        <span class="type">ApiClient</span>.getRestaurantList(completion: &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] (dataModels) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span>.dataSource = dataModels</span><br><span class="line">            completion(dataModels)</span><br><span class="line">            <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.post(name: dataChangedNotificationName, object: <span class="literal">nil</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>There are 2 methods in this class.</p>
<ul>
<li><strong>loadData()</strong> : It check if app is first load, It will call <em>ApiClient</em> to request server, otherwise it will call <em>PersistenceManager</em> to fetch Data Model.</li>
<li><strong>reloadData()</strong> : It will delete all data in Core Data and call <em>ApiClient*</em> to request new data from server.</li>
</ul>
<h3 id="Refactoring-feedVC"><a href="#Refactoring-feedVC" class="headerlink" title="Refactoring feedVC"></a>Refactoring feedVC</h3><p>Firstly, change the tint color of navigation bar to make app look nicer. Open <strong>Main.storyboard</strong>, select <strong>Navigation Bar</strong> in <em>FeedVC</em>‘s Navigation Controller.</p>
<img src="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/Select-navigationBar.png">
<p>Then, open <strong>Attributes Inspector</strong> and change <em>Bar tint</em> field like following:</p>
<img src="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/Change-tintColor.png">
<p>Secondly, add a <em>Bar Button Item</em> to FeedVC by drag-drop it from <strong>Object library</strong> to <strong>FeedVC</strong> navigation item in storyboard, select button and open <strong>Attributes Inspector</strong>, set <strong>System item</strong> to <strong>Refresh</strong>. Your <strong>FeedVC</strong> should look like this:</p>
<img src="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/add-refresh-btn.png">
<p>Thirdly, it’s time to create your feed view model. Go to <strong>File\New\File…</strong>, select <strong>iOS\Source\Swift File</strong> template and click <strong>Next</strong>. Name the file <strong>FeedViewModel</strong> and click <strong>Create</strong> to save the file. Add the following contents:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FeedViewModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> type: <span class="type">RestaurantType</span></span><br><span class="line">    <span class="keyword">var</span> rate: <span class="type">Double</span></span><br><span class="line">    <span class="keyword">var</span> image: <span class="type">UIImage</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> type &#123;</span><br><span class="line">        <span class="keyword">case</span> .hawk:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"bakery"</span>)</span><br><span class="line">        <span class="keyword">case</span> .coffee:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"coffee"</span>)</span><br><span class="line">        <span class="keyword">case</span> .fastfood:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"fastfood"</span>)</span><br><span class="line">        <span class="keyword">case</span> .streettea:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"water"</span>)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"food-icon"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(dataModel: <span class="type">RestaurantDataModel</span>) &#123;</span><br><span class="line">        name = dataModel.name</span><br><span class="line">        type = dataModel.type</span><br><span class="line">        rate = dataModel.rate</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Also, create detail view model with the same method in file <strong>DetailViewModel.swift</strong>:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">DetailViewModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> bio: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> type: <span class="type">RestaurantType</span></span><br><span class="line">    <span class="keyword">var</span> rate: <span class="type">Double</span></span><br><span class="line">    <span class="keyword">var</span> backGround: <span class="type">UIImage</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> type &#123;</span><br><span class="line">        <span class="keyword">case</span> .hawk:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"hawk-bg"</span>)</span><br><span class="line">        <span class="keyword">case</span> .coffee:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"coffee-bg"</span>)</span><br><span class="line">        <span class="keyword">case</span> .fastfood:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"fastfood-bg"</span>)</span><br><span class="line">        <span class="keyword">case</span> .streettea:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"streettea-bg"</span>)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"streettea-bg"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(dataModel: <span class="type">RestaurantDataModel</span>) &#123;</span><br><span class="line">        name = dataModel.name</span><br><span class="line">        bio = dataModel.bio</span><br><span class="line">        type = dataModel.type</span><br><span class="line">        rate = dataModel.rate</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The final step is refactoring <strong>FeedVC</strong> class. There are 2 sub-step</p>
<ul>
<li>Remove all code related to connect to server and parsing Core data. You’ve completed it in previous numberOfSections</li>
<li>Using view model to become data source of collection view in <strong>FeedVC</strong></li>
</ul>
<p>After that, your <strong>FeedVC</strong> should look like this:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> Alamofire</span><br><span class="line"><span class="keyword">import</span> PKHUD</span><br><span class="line"><span class="keyword">import</span> Cosmos</span><br><span class="line"><span class="keyword">import</span> CoreData</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FeedVC</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> feedCollectionView: <span class="type">UICollectionView</span>!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> feedData: [<span class="type">FeedViewModel</span>] = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        feedCollectionView.register(<span class="type">DemoCell</span>.nib, forCellWithReuseIdentifier: <span class="type">DemoCell</span>.identifier)</span><br><span class="line">        <span class="type">DataManager</span>.shareInstance.loadData(completion: &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span>] (restaurantModel) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">for</span> model <span class="keyword">in</span> restaurantModel &#123;</span><br><span class="line">                <span class="keyword">let</span> viewModel = <span class="type">FeedViewModel</span>(dataModel: model)</span><br><span class="line">                <span class="keyword">self</span>.feedData.append(viewModel)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">self</span>.feedCollectionView.reloadData()</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillTransition</span><span class="params">(to size: CGSize, with coordinator: UIViewControllerTransitionCoordinator)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewWillTransition(to: size, with: coordinator)</span><br><span class="line">        feedCollectionView.collectionViewLayout.invalidateLayout()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// MARK: - Navigation</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// In a storyboard-based application, you will often want to do a little preparation before navigation</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(<span class="keyword">for</span> segue: UIStoryboardSegue, sender: Any?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> segue.identifier == <span class="string">"showDetail"</span>, <span class="keyword">let</span> desVC = segue.destination <span class="keyword">as</span>? <span class="type">RestaurantDetailVC</span>, <span class="keyword">let</span> content = sender <span class="keyword">as</span>? <span class="type">RestaurantDataModel</span> &#123;</span><br><span class="line">            desVC.restaurant = <span class="type">DetailViewModel</span>(dataModel: content)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">refreshBtnClicked</span><span class="params">(<span class="number">_</span> sender: UIBarButtonItem)</span></span> &#123;</span><br><span class="line">        <span class="type">HUD</span>.show(.progress)</span><br><span class="line">        <span class="type">DataManager</span>.shareInstance.reloadData(completion: &#123;(restaurantModel) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span>.feedData.removeAll()</span><br><span class="line">            <span class="keyword">for</span> model <span class="keyword">in</span> restaurantModel &#123;</span><br><span class="line">                <span class="keyword">let</span> viewModel = <span class="type">FeedViewModel</span>(dataModel: model)</span><br><span class="line">                <span class="keyword">self</span>.feedData.append(viewModel)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">self</span>.feedCollectionView.reloadData()</span><br><span class="line">            <span class="type">HUD</span>.hide()</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">FeedVC</span>: <span class="title">UICollectionViewDelegate</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath)</span></span> &#123;</span><br><span class="line">        <span class="keyword">let</span> restaurant = <span class="type">DataManager</span>.shareInstance.dataSource[indexPath.row]</span><br><span class="line">        performSegue(withIdentifier: <span class="string">"showDetail"</span>, sender: restaurant)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">FeedVC</span>: <span class="title">UICollectionViewDataSource</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, numberOfItemsInSection section: Int)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> feedData.<span class="built_in">count</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, cellForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">UICollectionViewCell</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> cell = collectionView.dequeueReusableCell(withReuseIdentifier: <span class="type">DemoCell</span>.identifier, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">DemoCell</span></span><br><span class="line">        <span class="keyword">let</span> restaurant = feedData[indexPath.row]</span><br><span class="line">        cell.titleLbl.text = restaurant.name</span><br><span class="line">        cell.rateView.rating = restaurant.rate</span><br><span class="line">        cell.typeIcon.image = restaurant.image</span><br><span class="line">        <span class="keyword">return</span> cell</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">numberOfSections</span><span class="params">(<span class="keyword">in</span> collectionView: UICollectionView)</span></span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">FeedVC</span>: <span class="title">UICollectionViewDelegateFlowLayout</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">collectionView</span><span class="params">(<span class="number">_</span> collectionView: UICollectionView, layout collectionViewLayout: UICollectionViewLayout, sizeForItemAt indexPath: IndexPath)</span></span> -&gt; <span class="type">CGSize</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="type">UIDevice</span>.current.orientation &#123;</span><br><span class="line">        <span class="keyword">case</span> .landscapeLeft, .landscapeRight:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">CGSize</span>(width: collectionView.bounds.size.width / <span class="number">3</span> , height: <span class="number">150</span>)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="type">CGSize</span>(width: collectionView.bounds.size.width, height: <span class="number">60</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Open <strong>Main.storyboard</strong>, select <em>refresh</em> bar button in <strong>FeedVC</strong>, open <strong>Connections Inspector</strong> drag <strong>Send Action</strong> field to  <em>refreshBtnClicked()</em> function. Now you have finished refactoring <strong>FeedVC</strong>.</p>
<p>Also, you refactor <strong>RestaurantDetailVC</strong> class by adding <em>DetailViewModel*</em>. Replace following code to the file:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> Cosmos</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestaurantDetailVC</span>: <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> bioTextView: <span class="type">UITextView</span>!</span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> nameLbl: <span class="type">UILabel</span>!</span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> ratingView: <span class="type">CosmosView</span>!</span><br><span class="line">    <span class="meta">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> bgImg: <span class="type">UIImageView</span>!</span><br><span class="line">    <span class="keyword">var</span> restaurant: <span class="type">DetailViewModel</span>?</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> input = restaurant &#123;</span><br><span class="line">            bindingUI(input: input)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didReceiveMemoryWarning</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.didReceiveMemoryWarning()</span><br><span class="line">        <span class="comment">// Dispose of any resources that can be recreated.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// MARK: Ultilities function</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">bindingUI</span><span class="params">(input: DetailViewModel)</span></span> &#123;</span><br><span class="line">        nameLbl.text = input.name</span><br><span class="line">        ratingView.rating = input.rate</span><br><span class="line">        bioTextView.text = input.bio</span><br><span class="line">        bgImg.image = input.backGround</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Run and build project, you should see the result like this:</p>
<img src="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/final-screen.png">
<img src="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/final-screen-with-loading.png">
<img src="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/detail-screen.png">
<h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>In this article, the project has been refactored with MVVM. Overall, the project works similar the starter project, you only add refresh function and change navigation bar tint color but you can see that app works much faster than before. Combine with <em>Facade</em> pattern , project has been divided to small sub-system that easier to maintain.</p>
<p>Here is the <a href="https://github.com/quanrong88/DummyMap/tree/part2" target="_blank" rel="noopener">final project</a> of this part.</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-12-27</span><i class="fa fa-tag"></i><a href="/tags/Swift/" title="Swift" class="tag">Swift </a><a href="/tags/MVVM/" title="MVVM" class="tag">MVVM </a><a href="/tags/Facade/" title="Facade" class="tag">Facade </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://quanrong88.github.io/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/,Tạ Quân,Refactoring code with MVVM in Swift 3,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2018/01/03/Refactoring-code-with-Protocol-orient-programming-in-Swift-3/" title="Refactoring code with Protocol oriented Programming in Swift 3" class="btn">prev post</a></li><li class="next pagbuttons"><a role="navigation" href="/2017/12/19/My-simple-location-based-application/" title="My simple location based application" class="btn">next post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>