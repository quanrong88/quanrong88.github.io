<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Tạ Minh Quân,ta.quan@icloud.com"><title>Building microservices using Docker, Flask-RestPlus, Swagger UI, RabbitMQ and Nameko · Tạ Quân</title><meta name="description" content="This article presents a design for a simple application with microservices architecture. To build this project, 4 important tools have been used, they"><meta name="keywords" content="Hexo,Swift,Refactoring,iOS,Docker"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Tạ Quân</a></h3><div class="description"><p>Just make it simple.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/quanrong"><i class="fa fa-twitter"></i></a></li><li><a href="http://facebook.com/churongmayman"><i class="fa fa-facebook"></i></a></li><li><a href="http://github.com/quanrong88"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Archive</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"></a></li></div><div class="avatar"><img src="/images/blog_ava.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Building microservices using Docker, Flask-RestPlus, Swagger UI, RabbitMQ and Nameko</a></h3></div><div class="post-content"><p>This article presents a design for a simple application with microservices architecture. To build this project, 4 important tools have been used, they are Docker, Flask-RestPlus, RabbitMQ, and Nameko. The design will show us the advantages and disadvantages of microservices architecture.</p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p>Microservices is a variant of the service-oriented architecture (SOA) architectural style that structures an application as a collection of loosely coupled services. In a microservices architecture, services should be fine-grained and the protocols should be lightweight. The benefit of decomposing an application into different smaller services is that it improves modularity and makes the application easier to understand, develop and test. It also parallelizes development by enabling small autonomous teams to develop, deploy and scale their respective services independently.It also allows the architecture of an individual service to emerge through continuous refactoring. Microservices-based architectures enable continuous delivery and deployment.</p>
<p>In this article, we use following tools:</p>
<ul>
<li><p><strong>Flask-RestPlus</strong>: aims to make building REST APIs quick and easy. It provides just enough syntactic sugar to make your code readable and easy to maintain. The killer feature of RESTPlus is its ability to automatically generate an interactive documentation for your API using Swagger UI.</p>
</li>
<li><p><strong>Docker</strong> is a software technology providing containers, promoted by the company Docker, Inc. Docker provides an additional layer of abstraction and automation of operating-system-level virtualization on Windows and Linux. Docker uses the resource isolation features of the Linux kernel such as cgroups and kernel namespaces, and a union-capable file system such as OverlayFS and others to allow independent “containers” to run within a single Linux instance, avoiding the overhead of starting and maintaining virtual machines (VMs).</p>
</li>
<li><p><strong>RabbitMQ</strong> is an open source message broker software (sometimes called message-oriented middleware) that originally implemented the Advanced Message Queuing Protocol (AMQP) and has since been extended with a plug-in architecture to support Streaming Text Oriented Messaging Protocol (STOMP), MQTT, and other protocols [1]. The RabbitMQ server is written in the Erlang programming language and is built on the Open Telecom Platform framework for clustering and failover. Client libraries to interface with the broker are available for all major programming languages.</p>
</li>
<li><p><strong>Nameko</strong> is a framework for building microservices in Python.</p>
</li>
</ul>
<p>You should have the basic understanding some basic commands of <a href="https://docs.docker.com" target="_blank" rel="noopener">Docker</a> before getting start.</p>
<p>The aims of this project are to setup a simple microservices application and to compare with tradition monolithic architecture.</p>
<h3 id="Application-Structure-Overview"><a href="#Application-Structure-Overview" class="headerlink" title="Application Structure Overview"></a>Application Structure Overview</h3><p>In this project, you’re going to build a booking movie application that help user save the information of movie and the showtime of it. The application consists of several components including the swagger UI, with implements the user interface, along with some backend services checking user input, saving database.</p>
<p>If the application is deployed as a simple monolithic application, it will consist a single docker web container and a database container. This solution has a number of benefits:</p>
<ul>
<li>Simple to develop</li>
<li>Simple to deploy. Code is in a single container.</li>
<li>Simple to scale horizontally by running multiple copies behind a load balancer.</li>
</ul>
<p>With this architecture, project will be developed fast but after a long time, project become larger, there are some problem with it:</p>
<ul>
<li>This simple architecture has a limitation in size and complexity.</li>
<li>Application is too large and complex to fully understand and made changes fast and correctly.</li>
<li>Contiuous deployment is hard.</li>
<li>Changes will impact all application which leads to do extensive manual testing.</li>
<li>Adopting new technology is difficult. Changes in framework will affect an entire application it is extremely expensive in both time and cost.</li>
</ul>
<p>Because of below reasons, you will adopt <strong>Microservices architecture</strong> in this project. The idea is to split your application into a set of smaller, interconnected services instead of building a single monolithic application. Each microservice is a small application that has its own hexagonal architecture consisting of business logic along with various adapters. Some microservices would expose a REST, RPC or message-based API and most services consume APIs provided by other services.</p>
<p>Our application will divide into several container. The following deploy diagram show the architecture of application:</p>
<img src="/2018/01/15/Building-microservices-using-Flask-RestPlus-Swagger-UI-RabbitMQ-and-Nameko/part2DeployDiagram.png">
<p>We can see some benefits of <strong>Microservices architecture</strong>:</p>
<ul>
<li>Each microservice is deployed independently. It makes continuous deployment possible for complex application.</li>
<li>Each microservice can be scaled independently.</li>
<li>Adopting new technology is easy now. The changes in a microservice is not affect entire application.</li>
<li>Much easier to understand and maintain.</li>
<li>Enable each service to be developed independently by a team that is focused on that service.</li>
</ul>
<p>Also, we can realize some drawbacks of this architecture:</p>
<ul>
<li>It adds a complexity to the project by the fact that a microservices application is a distributed system. You need to choose and implement an inter-process communication mechanism. In this case we need to add a message broker to transfer RPC message between microservices.</li>
<li>It has the partitioned database architecture. The update database has relationships with each others is much harder than before.</li>
<li>Deploying a microservices-based application is also more complex.</li>
</ul>
<p>With small application like this project, <strong>Monolithic</strong> architecture is better choice. <strong>Microservices</strong> architecture pattern is the better choice for complex, evolving application. In order to study and compare this architecture, you’re going to program this project using <strong>Microservices</strong> approach.</p>
<h3 id="Setup-container-communication"><a href="#Setup-container-communication" class="headerlink" title="Setup container communication"></a>Setup container communication</h3><p>The first step for setting up project environment is creating a docker network. It allows containers communicate within it. Bridge networks offer the easiest solution to create your own Docker network. Open <strong>Terminal</strong> and type following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create -d bridge test-network</span><br></pre></td></tr></table></figure>
<p>This command creates a bridge network named <strong>test-network</strong></p>
<h3 id="Setup-RabbitMQ"><a href="#Setup-RabbitMQ" class="headerlink" title="Setup RabbitMQ"></a>Setup RabbitMQ</h3><p><strong>RabbitMQ</strong> is a message-queueing software called a message broker or queue manager. In this project, it use for transfer RPC message between containers. The easiest way to have a RabbitMQ in development environment is running its official docker container, considering you have Docker installed run:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --hostname rabbit-broker --name rabbit-broker -p 80:15672 --net test-network rabbitmq:3-management</span><br></pre></td></tr></table></figure>
<p>Go to the brower and access <a href="http://localhost:31" target="_blank" rel="noopener">http://localhost:31</a> using credentials <strong>guest:guest</strong> if you can login to RabbitMQ dashboard it means you have it running locally for development.</p>
<img src="/2018/01/15/Building-microservices-using-Flask-RestPlus-Swagger-UI-RabbitMQ-and-Nameko/rabbit-web.png">
<h3 id="Setup-MySQL-database"><a href="#Setup-MySQL-database" class="headerlink" title="Setup MySQL database"></a>Setup MySQL database</h3><p>In order to deploy MySQL database in local, you’re going to start a new docker container for the MySQL server with this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name base-mysql --net test-network -e MYSQL_ROOT_PASSWORD=quan -d mysql</span><br></pre></td></tr></table></figure>
<p>This command create new container from mysql image named <em>base-mysql</em> and run on <em>test-network</em>. Also, you’ve set the default password for root is <em>quan</em>. Now, access to the container by typing following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it base-mysql bash</span><br></pre></td></tr></table></figure>
<p>You should see some introductory information followed by a <em>#</em> prompt. Next, connect to mysql server by typing this following command and use password <em>quan</em>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># mysql -u root -p quan</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.7.20 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<p>The <em>mysql&gt;</em> prompt tells you that <em>mysql</em> is ready for you to enter SQL statements. Create new database named <strong>demoDb</strong> by typing this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE DATABASE demodb;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>Now, you’ve created the database will be used for this project. You can disconnect to sql server and move on next part by typing <em>quit</em> (or \q) at the mysql&gt; promp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; quit</span><br><span class="line">Bye</span><br></pre></td></tr></table></figure>
<p>Also, disconnect to the sql container by typing following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># exit</span><br></pre></td></tr></table></figure>
<h3 id="Setup-User-Module"><a href="#Setup-User-Module" class="headerlink" title="Setup User Module"></a>Setup User Module</h3><p>In this section, you’re going to create a docker container for user data management. For getting start, create a new forder named <strong>UserModule</strong> and change to this directory by typing following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir UserModule</span><br><span class="line">$ cd UserModule</span><br></pre></td></tr></table></figure>
<h4 id="Requirement-File"><a href="#Requirement-File" class="headerlink" title="Requirement File"></a>Requirement File</h4><p>Requirements file states the software required to be installed in the container. Create a file requirements.txt inside <strong>UserModule</strong> folder</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nameko</span><br><span class="line">sqlalchemy</span><br><span class="line">pymysql</span><br><span class="line">marshmallow</span><br></pre></td></tr></table></figure>
<h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><p>This file is needs to create a docker image and deploy it</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3-onbuild</span><br><span class="line">ADD . /code</span><br><span class="line">WORKDIR /code</span><br></pre></td></tr></table></figure>
<h4 id="Build-the-docker-image"><a href="#Build-the-docker-image" class="headerlink" title="Build the docker image"></a>Build the docker image</h4><p>Run the following command to build the docker image <em>user-module</em> from <strong>UserModule</strong> directory</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t user-module .</span><br></pre></td></tr></table></figure>
<h4 id="Run-the-Docker-Container"><a href="#Run-the-Docker-Container" class="headerlink" title="Run the Docker Container"></a>Run the Docker Container</h4><p>Run the following command to run <strong>user-module</strong> container in <strong>test-network</strong> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -it --name user-module -v $(pwd):/code --net test-network -e MYSQL_SERVER=base-mysql -e MYSQL_DATABASE=demodb -e MYSQL_USERNAME=root -e MYSQL_PASSWORD=quan user-module</span><br></pre></td></tr></table></figure>
<p>With this command, you’ve create new docker container named <strong>user-module</strong> , <strong>-v $(pwd):/code</strong> means copy all current forder’s content to code forder of container and you’ve embed the information of database server in environment variable with <strong>-e MYSQL_SERVER=base-mysql -e MYSQL_DATABASE=demodb -e MYSQL_USERNAME=root -e MYSQL_PASSWORD=quan</strong>. Now you’ve finished the init environment setup for user module.</p>
<h4 id="Declare-User-Database"><a href="#Declare-User-Database" class="headerlink" title="Declare User Database"></a>Declare User Database</h4><p>Using your text editor create an new file named <strong>database.py</strong> in the <strong>userModule</strong> forder and add following contents to this file:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Table, Column, Integer, String, MetaData, ForeignKey, create_engine</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line"><span class="comment">#1</span></span><br><span class="line">metadata = MetaData()</span><br><span class="line"><span class="comment">#2</span></span><br><span class="line">users = Table(<span class="string">'users'</span>, metadata,</span><br><span class="line">    Column(<span class="string">'id'</span>, Integer, primary_key=<span class="keyword">True</span>),</span><br><span class="line">    Column(<span class="string">'name'</span>, String(<span class="number">50</span>))</span><br><span class="line">)</span><br><span class="line"><span class="comment">#3</span></span><br><span class="line">serverName = os.getenv(<span class="string">'MYSQL_SERVER'</span>,<span class="string">'TEST'</span>)</span><br><span class="line">dbName = os.getenv(<span class="string">'MYSQL_DATABASE'</span>,<span class="string">'TEST'</span>)</span><br><span class="line">dbUserName = os.getenv(<span class="string">'MYSQL_USERNAME'</span>,<span class="string">'TEST'</span>)</span><br><span class="line">dbPassword = os.getenv(<span class="string">'MYSQL_PASSWORD'</span>,<span class="string">'TEST'</span>)</span><br><span class="line"><span class="comment">#4</span></span><br><span class="line">dbURI = <span class="string">'mysql://%s:%s@%s/%s'</span> % (dbUserName, dbPassword, serverName, dbName)</span><br><span class="line"><span class="comment">#5</span></span><br><span class="line">engine = create_engine(dbURI)</span><br></pre></td></tr></table></figure>
<ol>
<li>Declare <em>metadata</em> variable</li>
<li>Declare <em>users</em> variable. It represents your <em>users</em> table in database.</li>
<li>Get the mysql database server’s information from environment variables.</li>
<li>Build database server URI.</li>
<li>Declare <em>engine</em> by running sqlalchemy command create_engine.</li>
</ol>
<p>Next, you need to connect to <strong>user-module</strong> command line cli. Type following in your terminal:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it user-module bash</span><br></pre></td></tr></table></figure>
<p>Then, enter the python prompt to run python code by enter this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># python</span><br><span class="line">Python 3.6.4 (default, Dec 21 2017, 01:35:12)</span><br><span class="line">[GCC 4.9.2] on linux</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>Finally, type following commands to create the databse using sqlalchemy framework:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; from database import engine, metadata</span><br><span class="line">&gt;&gt;&gt; metadata.create_all(engine)</span><br></pre></td></tr></table></figure>
<h4 id="Declare-database-schema"><a href="#Declare-database-schema" class="headerlink" title="Declare database schema"></a>Declare database schema</h4><p>At this point, you’ve create the <strong>user</strong> table and be able to query the database. The query result is sqlalchemy object so you need to serialize to a JSON-encoded string by using <strong>marshmallow</strong> library. Open text editor, create a new file named <strong>serializer.py</strong> and add following content to this file:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSchema</span><span class="params">(Schema)</span>:</span></span><br><span class="line">    id = fields.Integer()</span><br><span class="line">    name = fields.Str()</span><br></pre></td></tr></table></figure>
<h4 id="The-service-code"><a href="#The-service-code" class="headerlink" title="The service code"></a>The service code</h4><p>Now, you have the RabbitMQ and MySQL container work normally. Let’s code the nameko RPC services. In this article, the service only does some basic CRUD operation to keep it small and simple. Open text editor, create new file named <strong>service.py</strong> and add following content:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nameko.rpc <span class="keyword">import</span> rpc, RpcProxy</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> database <span class="keyword">import</span> engine, metadata, users</span><br><span class="line"><span class="keyword">from</span> serializer <span class="keyword">import</span> UserSchema</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserService</span><span class="params">(object)</span>:</span></span><br><span class="line">    name = <span class="string">"userService"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span><span class="params">(self)</span>:</span></span><br><span class="line">        command = users.select()</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line">        results = resultsProxy.fetchall()</span><br><span class="line">        schema = UserSchema(many=<span class="keyword">True</span>)</span><br><span class="line">        resultDic = schema.dump(results)</span><br><span class="line">        resultsProxy.close()</span><br><span class="line">        <span class="keyword">return</span> resultDic.data</span><br><span class="line"></span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getUserByName</span><span class="params">(self, user_id)</span>:</span></span><br><span class="line">        command = users.select().where(users.c.id == user_id)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line">        results = resultsProxy.fetchone()</span><br><span class="line">        schema = UserSchema()</span><br><span class="line">        resultDic = schema.dump(results)</span><br><span class="line">        resultsProxy.close()</span><br><span class="line">        <span class="keyword">return</span> resultDic.data</span><br><span class="line"></span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createNewUser</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        username = data.get(<span class="string">'name'</span>)</span><br><span class="line">        command = users.insert().values(name=username)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deleteUser</span><span class="params">(self,user_id)</span>:</span></span><br><span class="line">        command = users.delete().where(users.c.id==user_id)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">updateUser</span><span class="params">(self,user_id, data)</span>:</span></span><br><span class="line">        username = data.get(<span class="string">'name'</span>)</span><br><span class="line">        command = users.update().where(users.c.id==user_id).values(name=username)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br></pre></td></tr></table></figure>
<h4 id="Run-the-services"><a href="#Run-the-services" class="headerlink" title="Run the services"></a>Run the services</h4><p>Connect to the <strong>user-module</strong> container’s command line cli by typing this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it user-module bash</span><br></pre></td></tr></table></figure>
<p>Run nameko <em>userModule</em> service by typing following in <strong>user-module</strong> ‘s command line cli:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># nameko run service --broker amqp://guest:guest@rabbit-broker</span><br><span class="line">starting services: userService</span><br><span class="line">Connected to amqp://guest:**@rabbit-broker:5672//</span><br></pre></td></tr></table></figure>
<h3 id="Setup-Movie-module"><a href="#Setup-Movie-module" class="headerlink" title="Setup Movie module"></a>Setup Movie module</h3><p>This module uses for movie data management. Similar to user module, you create a new forder for this section by typing following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd ..</span><br><span class="line">$ mkdir movieModule</span><br><span class="line">$ cd movieModule</span><br></pre></td></tr></table></figure>
<h4 id="Build-the-docker-image-1"><a href="#Build-the-docker-image-1" class="headerlink" title="Build the docker image"></a>Build the docker image</h4><p>We use the same library with the user module so copy the <strong>Dockerfile</strong> and <strong>requirements.txt</strong> from <strong>userModule</strong> forder to <strong>movieModule</strong> forder. Then, run the following to build the movie container:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t user-module .</span><br></pre></td></tr></table></figure>
<h4 id="Run-the-Docker-Container-1"><a href="#Run-the-Docker-Container-1" class="headerlink" title="Run the Docker Container"></a>Run the Docker Container</h4><p>Run the following command to start the container:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -it --name movie-module -v $(pwd):/code --net test-network -e MYSQL_SERVER=base-mysql -e MYSQL_DATABASE=demodb -e MYSQL_USERNAME=root -e MYSQL_PASSWORD=quan movie-module</span><br></pre></td></tr></table></figure>
<h4 id="Declare-Movie-Database"><a href="#Declare-Movie-Database" class="headerlink" title="Declare Movie Database"></a>Declare Movie Database</h4><p>Creat new file <strong>database.py</strong> in <strong>movieModule</strong> add following content:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Table, Column, Integer, String, MetaData, ForeignKey, create_engine, Float</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line">metadata = MetaData()</span><br><span class="line">movies = Table(<span class="string">'movies'</span>, metadata,</span><br><span class="line">    Column(<span class="string">'id'</span>, Integer, primary_key=<span class="keyword">True</span>),</span><br><span class="line">    Column(<span class="string">'title'</span>, String(<span class="number">50</span>)),</span><br><span class="line">    Column(<span class="string">'director'</span>, String(<span class="number">50</span>)),</span><br><span class="line">    Column(<span class="string">'ranking'</span>, Float),</span><br><span class="line">)</span><br><span class="line">serverName = os.getenv(<span class="string">'MYSQL_SERVER'</span>,<span class="string">'TEST'</span>)</span><br><span class="line">dbName = os.getenv(<span class="string">'MYSQL_DATABASE'</span>,<span class="string">'TEST'</span>)</span><br><span class="line">dbUserName = os.getenv(<span class="string">'MYSQL_USERNAME'</span>,<span class="string">'TEST'</span>)</span><br><span class="line">dbPassword = os.getenv(<span class="string">'MYSQL_PASSWORD'</span>,<span class="string">'TEST'</span>)</span><br><span class="line">dbURI = <span class="string">'mysql://%s:%s@%s/%s'</span> % (dbUserName, dbPassword, serverName, dbName)</span><br><span class="line">engine = create_engine(dbURI)</span><br></pre></td></tr></table></figure>
<p>You create movie database the same method creating user database. Type following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it movie-module bash</span><br></pre></td></tr></table></figure>
<p>Enter python prompt and create the movie table:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># python</span><br><span class="line">Python 3.6.4 (default, Dec 21 2017, 01:35:12)</span><br><span class="line">[GCC 4.9.2] on linux</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">&gt;&gt;&gt; from database import engine, metadata</span><br><span class="line">&gt;&gt;&gt; metadata.create_all(engine)</span><br></pre></td></tr></table></figure>
<h4 id="Declare-database-schema-1"><a href="#Declare-database-schema-1" class="headerlink" title="Declare database schema"></a>Declare database schema</h4><p>Create <strong>serializer.py</strong> file of this module and add following content:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieSchema</span><span class="params">(Schema)</span>:</span></span><br><span class="line">    id = fields.Integer()</span><br><span class="line">    title = fields.Str()</span><br><span class="line">    director = fields.Str()</span><br><span class="line">    ranking = fields.Float()</span><br></pre></td></tr></table></figure>
<h4 id="The-service-code-1"><a href="#The-service-code-1" class="headerlink" title="The service code"></a>The service code</h4><p>Final step of this section is creating <strong>service.py</strong> file and add following content:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nameko.rpc <span class="keyword">import</span> rpc, RpcProxy</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> database <span class="keyword">import</span> engine, metadata, movies</span><br><span class="line"><span class="keyword">from</span> serializer <span class="keyword">import</span> MovieSchema</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MoviesService</span><span class="params">(object)</span>:</span></span><br><span class="line">    name=<span class="string">"moviesService"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span><span class="params">(self)</span>:</span></span><br><span class="line">        command = movies.select()</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line">        results = resultsProxy.fetchall()</span><br><span class="line">        schema = MovieSchema(many=<span class="keyword">True</span>)</span><br><span class="line">        resultDic = schema.dump(results)</span><br><span class="line">        resultsProxy.close()</span><br><span class="line">        <span class="keyword">return</span> resultDic.data</span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getMovieById</span><span class="params">(self,movie_id)</span>:</span></span><br><span class="line">        command = movies.select().where(movies.c.id == movie_id)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line">        results = resultsProxy.fetchone()</span><br><span class="line">        schema = MovieSchema()</span><br><span class="line">        resultDic = schema.dump(results)</span><br><span class="line">        resultsProxy.close()</span><br><span class="line">        <span class="keyword">return</span> resultDic.data</span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createNewMovies</span><span class="params">(self,data)</span>:</span></span><br><span class="line">        titleVal = data.get(<span class="string">'title'</span>)</span><br><span class="line">        directorVal = data.get(<span class="string">'director'</span>)</span><br><span class="line">        rankingVal = data.get(<span class="string">'ranking'</span>)</span><br><span class="line">        command = movies.insert().values(title=titleVal,director=directorVal,ranking=rankingVal)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deleteMovie</span><span class="params">(self,movie_id)</span>:</span></span><br><span class="line">        command = movies.delete().where(movies.c.id==movie_id)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">updateMovie</span><span class="params">(self,movie_id, data)</span>:</span></span><br><span class="line">        titleVal = data.get(<span class="string">'title'</span>)</span><br><span class="line">        directorVal = data.get(<span class="string">'director'</span>)</span><br><span class="line">        rankingVal = data.get(<span class="string">'ranking'</span>)</span><br><span class="line">        command = movies.update().where(movies.c.id==movie_id).values(title=titleVal,director=directorVal,ranking=rankingVal)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br></pre></td></tr></table></figure>
<h4 id="Run-the-services-1"><a href="#Run-the-services-1" class="headerlink" title="Run the services"></a>Run the services</h4><p>Connect to the <strong>movie-module</strong> container’s command line cli by typing this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it movie-module bash</span><br></pre></td></tr></table></figure>
<p>Run nameko <em>movieModule</em> service by typing following in <strong>movie-module</strong> ‘s command line cli:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># nameko run service --broker amqp://guest:guest@rabbit-broker</span><br><span class="line">starting services: movieService</span><br><span class="line">Connected to amqp://guest:**@rabbit-broker:5672//</span><br></pre></td></tr></table></figure>
<h3 id="Setup-Booking-Module"><a href="#Setup-Booking-Module" class="headerlink" title="Setup Booking Module"></a>Setup Booking Module</h3><p>The final data management module in this project is booking module. Like 2 below module, you create a new forder for this section by typing following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd ..</span><br><span class="line">$ mkdir bookingsModule</span><br><span class="line">$ cd bookingsModule</span><br></pre></td></tr></table></figure>
<h4 id="Build-the-docker-image-2"><a href="#Build-the-docker-image-2" class="headerlink" title="Build the docker image"></a>Build the docker image</h4><p>We use the same library with 2 below so copy the <strong>Dockerfile</strong> and <strong>requirements.txt</strong> from <strong>userModule</strong> forder to <strong>bookingsModule</strong> forder. Then, run the following to build the movie container:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t booking-module .</span><br></pre></td></tr></table></figure>
<h4 id="Run-the-Docker-Container-2"><a href="#Run-the-Docker-Container-2" class="headerlink" title="Run the Docker Container"></a>Run the Docker Container</h4><p>Run the following command to start the container:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -it --name booking-module -v $(pwd):/code --net test-network -e MYSQL_SERVER=base-mysql -e MYSQL_DATABASE=demodb -e MYSQL_USERNAME=root -e MYSQL_PASSWORD=quan booking-module</span><br></pre></td></tr></table></figure>
<h4 id="Declare-Bookings-Database"><a href="#Declare-Bookings-Database" class="headerlink" title="Declare Bookings Database"></a>Declare Bookings Database</h4><p>Creat new file <strong>database.py</strong> in <strong>bookingsModule</strong> add following content:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Table, Column, Integer, String, MetaData, ForeignKey, create_engine, ARRAY,DateTime,func</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line">metadata = MetaData()</span><br><span class="line">bookings = Table(<span class="string">'bookings'</span>, metadata,</span><br><span class="line">    Column(<span class="string">'id'</span>, Integer, primary_key=<span class="keyword">True</span>),</span><br><span class="line">    Column(<span class="string">'userId'</span>, Integer),</span><br><span class="line">    Column(<span class="string">'movieIds'</span>, String(<span class="number">100</span>)),</span><br><span class="line">    Column(<span class="string">'pubDate'</span>, DateTime, onupdate=func.utc_timestamp())</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line">serverName = os.getenv(<span class="string">'MYSQL_SERVER'</span>,<span class="string">'TEST'</span>)</span><br><span class="line">dbName = os.getenv(<span class="string">'MYSQL_DATABASE'</span>,<span class="string">'TEST'</span>)</span><br><span class="line">dbUserName = os.getenv(<span class="string">'MYSQL_USERNAME'</span>,<span class="string">'TEST'</span>)</span><br><span class="line">dbPassword = os.getenv(<span class="string">'MYSQL_PASSWORD'</span>,<span class="string">'TEST'</span>)</span><br><span class="line">dbURI = <span class="string">'mysql://%s:%s@%s/%s'</span> % (dbUserName, dbPassword, serverName, dbName)</span><br><span class="line">engine = create_engine(dbURI)</span><br></pre></td></tr></table></figure>
<p>You create movie database the same method creating user database. Type following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it booking-module bash</span><br></pre></td></tr></table></figure>
<p>Enter python prompt and create the movie table:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># python</span><br><span class="line">Python 3.6.4 (default, Dec 21 2017, 01:35:12)</span><br><span class="line">[GCC 4.9.2] on linux</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">&gt;&gt;&gt; from database import engine, metadata</span><br><span class="line">&gt;&gt;&gt; metadata.create_all(engine)</span><br></pre></td></tr></table></figure>
<h4 id="Declare-database-schema-2"><a href="#Declare-database-schema-2" class="headerlink" title="Declare database schema"></a>Declare database schema</h4><p>Create <strong>serializer.py</strong> file of this module and add following content:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListField</span><span class="params">(fields.Field)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_serialize</span><span class="params">(self, value, attr, obj)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">return</span> value.split(<span class="string">","</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookingSchema</span><span class="params">(Schema)</span>:</span></span><br><span class="line">    id = fields.Integer()</span><br><span class="line">    name = fields.Str()</span><br><span class="line">    userId = fields.Integer()</span><br><span class="line">    pubDate = fields.DateTime(format=<span class="string">"%Y-%m-%d %H:%M:%S"</span>)</span><br><span class="line">    movieIdsList = ListField(attribute=<span class="string">"movieIds"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="The-service-code-2"><a href="#The-service-code-2" class="headerlink" title="The service code"></a>The service code</h4><p>Final step of this section is creating <strong>service.py</strong> file and add following content:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> nameko.rpc <span class="keyword">import</span> rpc, RpcProxy</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> database <span class="keyword">import</span> engine, metadata, bookings</span><br><span class="line"><span class="keyword">from</span> serializer <span class="keyword">import</span> BookingSchema</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookingsService</span><span class="params">(object)</span>:</span></span><br><span class="line">    name=<span class="string">"bookingsService"</span></span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span><span class="params">(self)</span>:</span></span><br><span class="line">        command = bookings.select()</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line">        results = resultsProxy.fetchall()</span><br><span class="line">        schema = BookingSchema(many=<span class="keyword">True</span>)</span><br><span class="line">        resultDic = schema.dump(results)</span><br><span class="line">        resultsProxy.close()</span><br><span class="line">        <span class="keyword">return</span> resultDic.data</span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getByUserId</span><span class="params">(self, user_id)</span>:</span></span><br><span class="line">        command = bookings.select().where(bookings.c.userId == user_id)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line">        results = resultsProxy.fetchall()</span><br><span class="line">        schema = BookingSchema(many=<span class="keyword">True</span>)</span><br><span class="line">        resultDic = schema.dump(results)</span><br><span class="line">        resultsProxy.close()</span><br><span class="line">        <span class="keyword">return</span> resultDic.data</span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getById</span><span class="params">(self, booking_id)</span>:</span></span><br><span class="line">        command = bookings.select().where(bookings.c.id == booking_id)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line">        results = resultsProxy.fetchone()</span><br><span class="line">        schema = BookingSchema()</span><br><span class="line">        resultDic = schema.dump(results)</span><br><span class="line">        resultsProxy.close()</span><br><span class="line">        <span class="keyword">return</span> resultDic.data</span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createNewBooking</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        userIdVal = data.get(<span class="string">'userId'</span>)</span><br><span class="line">        movieIdsVal = data.get(<span class="string">'movieIds'</span>)</span><br><span class="line">        pubDateVal = data.get(<span class="string">'pubDate'</span>)</span><br><span class="line">        movieIdsString = <span class="string">','</span>.join(map(str, movieIdsVal))</span><br><span class="line">        command = bookings.insert().values(userId=userIdVal,movieIds=movieIdsString,pubDate=pubDateVal)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deleteBooking</span><span class="params">(self, booking_id)</span>:</span></span><br><span class="line">        command = bookings.delete().where(bookings.c.id==booking_id)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br><span class="line"><span class="meta">    @rpc</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">updateBooking</span><span class="params">(self, booking_id, data)</span>:</span></span><br><span class="line">        userIdVal = data.get(<span class="string">'userId'</span>)</span><br><span class="line">        movieIdsVal = data.get(<span class="string">'movieIds'</span>)</span><br><span class="line">        pubDateVal = data.get(<span class="string">'pubDate'</span>)</span><br><span class="line">        movieIdsString = <span class="string">','</span>.join(map(str, movieIdsVal))</span><br><span class="line">        command = bookings.update().where(bookings.c.id==booking_id).values(userId=userIdVal,movieIds=movieIdsString,pubDate=pubDateVal)</span><br><span class="line">        resultsProxy = engine.execute(command)</span><br></pre></td></tr></table></figure>
<h4 id="Run-the-services-2"><a href="#Run-the-services-2" class="headerlink" title="Run the services"></a>Run the services</h4><p>Connect to the <strong>booking-module</strong> container’s command line cli by typing this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it booking-module bash</span><br></pre></td></tr></table></figure>
<p>Run nameko <em>bookingsModule</em> service by typing following in <strong>booking-module</strong> ‘s command line cli:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># nameko run service --broker amqp://guest:guest@rabbit-broker</span><br><span class="line">starting services: bookingsService</span><br><span class="line">Connected to amqp://guest:**@rabbit-broker:5672//</span><br></pre></td></tr></table></figure>
<h3 id="Setup-Flask-RESTPlus-module"><a href="#Setup-Flask-RESTPlus-module" class="headerlink" title="Setup Flask RESTPlus module"></a>Setup Flask RESTPlus module</h3><p>This module provide web Swagger UI to interact with 3 inner modules. For getting start, create a new forder named <strong>flaskModule</strong> and change to this directory by typing following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd ..</span><br><span class="line">$ mkdir flaskModule</span><br><span class="line">$ cd flaskModule</span><br></pre></td></tr></table></figure>
<h4 id="Requirement-File-1"><a href="#Requirement-File-1" class="headerlink" title="Requirement File"></a>Requirement File</h4><p>Create a file requirements.txt inside <strong>flaskModule</strong> folder with following content:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flask</span><br><span class="line">flask-restplus</span><br><span class="line">nameko</span><br></pre></td></tr></table></figure>
<h4 id="Dockerfile-1"><a href="#Dockerfile-1" class="headerlink" title="Dockerfile"></a>Dockerfile</h4><p>Create <strong>Dockerfile</strong> in current directory and add following content:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3-onbuild</span><br><span class="line">ADD . /code</span><br><span class="line">WORKDIR /code</span><br><span class="line">CMD [ &quot;python&quot;, &quot;./app.py&quot; ]</span><br></pre></td></tr></table></figure>
<h4 id="Defining-your-Flask-app"><a href="#Defining-your-Flask-app" class="headerlink" title="Defining your Flask app"></a>Defining your Flask app</h4><p>Flask and Flask-RESTPlus make it very easy to get started. For getting started, create <strong>app.py</strong> file add 10 lines of <em>hello world</em> working api:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask_restplus <span class="keyword">import</span> Resource, Api</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)                  </span><br><span class="line">api = Api(app)                         </span><br><span class="line"></span><br><span class="line"><span class="meta">@api.route('/hello')                   </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span><span class="params">(Resource)</span>:</span>           </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span>                     </span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'hello'</span>: <span class="string">'world'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">"0.0.0.0"</span>, debug=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Build-the-docker-image-3"><a href="#Build-the-docker-image-3" class="headerlink" title="Build the docker image"></a>Build the docker image</h4><p>Run the following command to build the docker image <em>flask-module</em> from <strong>flaskModule</strong> directory</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t flask-module .</span><br></pre></td></tr></table></figure>
<h4 id="Run-the-Docker-Container-3"><a href="#Run-the-Docker-Container-3" class="headerlink" title="Run the Docker Container"></a>Run the Docker Container</h4><p>Run the following command to run <strong>flask-module</strong> container in <strong>test-network</strong> :</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -it --name flask-view -v $(pwd):/code --net test-network -p 30:5000 -e BROKER_NAME=rabbit-broker -e BROKER_USERNAME=guest -e BROKER_PASSWORD=guest flask-module</span><br></pre></td></tr></table></figure>
<p>Now everything should be ready. In your brower, open the URL <a href="http://localhost:30/" target="_blank" rel="noopener">http://localhost:30/</a>. You should see Swagger UI similar to the following:</p>
<img src="/2018/01/15/Building-microservices-using-Flask-RestPlus-Swagger-UI-RabbitMQ-and-Nameko/swager-ui-hello.png">
<h4 id="Defining-API-namespaces-and-RESTful-resources"><a href="#Defining-API-namespaces-and-RESTful-resources" class="headerlink" title="Defining API namespaces and RESTful resources"></a>Defining API namespaces and RESTful resources</h4><p>In this project, the API is splited into 3 separate namespaces. Each namespace has it own URL prefix and is stored in a separate file in <em>/services</em> directory. Run following command to create this forder:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir services</span><br></pre></td></tr></table></figure>
<p><a href="http://restful-api-design.readthedocs.io/en/latest/resources.html" target="_blank" rel="noopener">RestPlus resources</a> are used to organize the API into endpoints corresponding to different types of data used by your application. Each endpoint is called using a different HTTP method. Each method issues a different command to the API. For example, GET is used to fetch a resource from the API, PUT is used to update its information, DELETE to delete it.</p>
<p>We start by creating user namespace, we create a collection, a resource and associated HTTP methods.</p>
<ul>
<li><em>GET /user/</em> - Retrieve a list of user</li>
<li><em>POST /user/</em> - Create new user</li>
<li><em>GET /user/1</em> - Retrieve information of user with ID 1</li>
<li><em>PUT /user/1</em> - Update information of user with ID 1</li>
<li><em>DELETE /user/1</em> - Delete user with ID 1</li>
<li><em>GET /user/1/Bookings/</em> - Retrieve with ID 1 ‘s information of bookings</li>
</ul>
<p>Create a python file <strong>user.py</strong> inside <strong>services</strong> directory. Using Flask RESTful you can define an API for all of the endpoints listed above with following block of code :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> flask_restplus <span class="keyword">import</span> Resource, reqparse</span><br><span class="line"><span class="keyword">from</span> restplus <span class="keyword">import</span> api</span><br><span class="line"><span class="keyword">from</span> nameko.standalone.rpc <span class="keyword">import</span> ClusterRpcProxy</span><br><span class="line"><span class="keyword">from</span> serializers <span class="keyword">import</span> user_parser</span><br><span class="line"><span class="keyword">from</span> services <span class="keyword">import</span> CONFIG</span><br><span class="line"></span><br><span class="line">ns = api.namespace(<span class="string">'user/'</span>, description=<span class="string">'Operations related to user'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@ns.route('/')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">showListUsers</span><span class="params">(Resource)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            <span class="keyword">return</span> rpc.userService.list()</span><br><span class="line"><span class="meta">    @api.expect(user_parser)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            args = user_parser.parse_args()</span><br><span class="line">            rpc.userService.createNewUser(args)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'message'</span>:<span class="string">'Done'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ns.route('/&lt;int:user_id&gt;')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">showUser</span><span class="params">(Resource)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,user_id)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            <span class="keyword">return</span> rpc.userService.getUserByName(user_id)</span><br><span class="line"><span class="meta">    @api.expect(user_parser)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self,user_id)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            args = user_parser.parse_args()</span><br><span class="line">            rpc.userService.updateUser(user_id, args)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'message'</span>:<span class="string">'Done'</span>&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, user_id)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            rpc.userService.deleteUser(user_id)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'message'</span>:<span class="string">'Done'</span>&#125;</span><br><span class="line"><span class="meta">@ns.route('/&lt;string:user_id&gt;/Bookings/')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">showBookingsForUsername</span><span class="params">(Resource)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,user_id)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            userBookings = rpc.bookingsService.getByUserId(user_id)</span><br><span class="line">            results = []</span><br><span class="line">            <span class="keyword">for</span> bookingDic <span class="keyword">in</span> userBookings:</span><br><span class="line">                tempDic = &#123;&#125;</span><br><span class="line">                tempDic[<span class="string">'id'</span>]=bookingDic[<span class="string">'id'</span>]</span><br><span class="line">                tempDic[<span class="string">'pubDate'</span>]=bookingDic[<span class="string">'pubDate'</span>]</span><br><span class="line">                moviesList = []</span><br><span class="line">                <span class="keyword">for</span> movieId <span class="keyword">in</span> bookingDic[<span class="string">'movieIdsList'</span>]:</span><br><span class="line">                    movieDic = rpc.moviesService.getMovieById(movieId)</span><br><span class="line">                    <span class="keyword">if</span>(bool(movieDic)):</span><br><span class="line">                        moviesList.append(movieDic)</span><br><span class="line">                tempDic[<span class="string">'movies'</span>] = moviesList</span><br><span class="line">                results.append(tempDic)</span><br><span class="line">            <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure>
<p>The <strong>api.namespace()</strong> function creates a new namespace with a URL prefix. The <strong>description</strong> field will be used in the Swagger UI to describe this set of methods.</p>
<p>The <strong>@ns.route()</strong> decorator is used to specify which URLs will be associated with a given resource. You can specify path parameters using angle brackets, such as in <strong>@ns.route(‘/<int:user_id>‘)</int:user_id></strong>.</p>
<p>Each resource is a class which contains functions which will be mapped to HTTP methods. The following functions are mapped: <em>get</em>, <em>post</em>, <em>put</em>, <em>delete</em>, <em>patch</em>, <em>options</em> and <em>head</em>.</p>
<p>The <strong>@api.expect()</strong> decorator allows you to specify the expected input fields. The detail for it will be present in next section.</p>
<p>Similar, you create the <strong>movies.py</strong> for movie namespace with following code:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> flask_restplus <span class="keyword">import</span> Resource</span><br><span class="line"><span class="keyword">from</span> restplus <span class="keyword">import</span> api</span><br><span class="line"><span class="keyword">from</span> nameko.standalone.rpc <span class="keyword">import</span> ClusterRpcProxy</span><br><span class="line"><span class="keyword">from</span> serializers <span class="keyword">import</span> movie_parser</span><br><span class="line"><span class="keyword">from</span> services <span class="keyword">import</span> CONFIG</span><br><span class="line"></span><br><span class="line">ns = api.namespace(<span class="string">'movies/'</span>, description=<span class="string">'Operations related to movies'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@ns.route('/')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetMovies</span><span class="params">(Resource)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            <span class="keyword">return</span> rpc.moviesService.list()</span><br><span class="line"><span class="meta">    @api.expect(movie_parser)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            args = movie_parser.parse_args()</span><br><span class="line">            rpc.moviesService.createNewMovies(args)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'message'</span>:<span class="string">'Done'</span>&#125;</span><br><span class="line"><span class="meta">@ns.route('/&lt;string:movie_id&gt;')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetMovieById</span><span class="params">(Resource)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, movie_id)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            <span class="keyword">return</span> rpc.moviesService.getMovieById(movie_id)</span><br><span class="line"><span class="meta">    @api.expect(movie_parser)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, movie_id)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            args = movie_parser.parse_args()</span><br><span class="line">            rpc.moviesService.updateMovie(movie_id,args)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'message'</span>:<span class="string">'Done'</span>&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self,movie_id)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            rpc.moviesService.deleteMovie(movie_id)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'message'</span>:<span class="string">'Done'</span>&#125;</span><br></pre></td></tr></table></figure>
<p>Finally, create <strong>bookings.py</strong> for bookings namespace:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> flask_restplus <span class="keyword">import</span> Resource</span><br><span class="line"><span class="keyword">from</span> restplus <span class="keyword">import</span> api</span><br><span class="line"><span class="keyword">from</span> nameko.standalone.rpc <span class="keyword">import</span> ClusterRpcProxy</span><br><span class="line"><span class="keyword">from</span> serializers <span class="keyword">import</span> booking_parser</span><br><span class="line"><span class="keyword">from</span> services <span class="keyword">import</span> CONFIG</span><br><span class="line"></span><br><span class="line">ns = api.namespace(<span class="string">'bookings/'</span>, description=<span class="string">'Operations related to bookings'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@ns.route('/')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetBookings</span><span class="params">(Resource)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            <span class="keyword">return</span> rpc.bookingsService.list()</span><br><span class="line"><span class="meta">    @api.expect(booking_parser)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            args = booking_parser.parse_args()</span><br><span class="line">            rpc.bookingsService.createNewBooking(args)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'message'</span>:<span class="string">'Done'</span>&#125;</span><br><span class="line"><span class="meta">@ns.route('/&lt;string:booking_id&gt;')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetBookingsForUsername</span><span class="params">(Resource)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, booking_id)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            bookingsDic = rpc.bookingsService.getById(booking_id)</span><br><span class="line">            result = &#123;&#125;</span><br><span class="line">            result[<span class="string">'id'</span>] = bookingsDic[<span class="string">'id'</span>]</span><br><span class="line">            result[<span class="string">'pubDate'</span>] = bookingsDic[<span class="string">'pubDate'</span>]</span><br><span class="line">            moviesList = []</span><br><span class="line">            <span class="keyword">for</span> movieId <span class="keyword">in</span> bookingsDic[<span class="string">'movieIdsList'</span>]:</span><br><span class="line">                movieDic = rpc.moviesService.getMovieById(movieId)</span><br><span class="line">                <span class="keyword">if</span>(bool(movieDic)):</span><br><span class="line">                    moviesList.append(movieDic)</span><br><span class="line">            result[<span class="string">'movies'</span>] = moviesList</span><br><span class="line">            result[<span class="string">'user'</span>] = rpc.userService.getUserByName(bookingsDic[<span class="string">'userId'</span>])</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line"><span class="meta">    @api.expect(booking_parser)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, booking_id)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            args = booking_parser.parse_args()</span><br><span class="line">            rpc.bookingsService.updateBooking(booking_id, args)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'message'</span>:<span class="string">'Done'</span>&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, booking_id)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> ClusterRpcProxy(CONFIG) <span class="keyword">as</span> rpc:</span><br><span class="line">            rpc.bookingsService.deleteBooking(booking_id)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'message'</span>:<span class="string">'Done'</span>&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Define-API-parameters"><a href="#Define-API-parameters" class="headerlink" title="Define API parameters"></a>Define API parameters</h4><p>In order to define these parameters, we use an object called the <strong>RequestParser</strong>. The parser has a function named <strong>add_argument()</strong>, which allows us to specify what the parameter is named and what its allowed values are. From <strong>flaskModule</strong> directory, create a new python file named <strong>serializers.py</strong> and add following code:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_restplus <span class="keyword">import</span> fields, reqparse</span><br><span class="line"><span class="keyword">from</span> restplus <span class="keyword">import</span> api</span><br><span class="line"></span><br><span class="line">movie_parser = reqparse.RequestParser()</span><br><span class="line">movie_parser.add_argument(<span class="string">'title'</span>, location=<span class="string">'form'</span>)</span><br><span class="line">movie_parser.add_argument(<span class="string">'director'</span>, location=<span class="string">'form'</span>)</span><br><span class="line">movie_parser.add_argument(<span class="string">'ranking'</span>, location=<span class="string">'form'</span>)</span><br><span class="line"></span><br><span class="line">booking_parser = reqparse.RequestParser()</span><br><span class="line">booking_parser.add_argument(<span class="string">'userId'</span>, type=int, location=<span class="string">'form'</span>)</span><br><span class="line">booking_parser.add_argument(<span class="string">'movieIds'</span>, action=<span class="string">'append'</span>, location=<span class="string">'form'</span>)</span><br><span class="line">booking_parser.add_argument(<span class="string">'pubDate'</span>, location=<span class="string">'form'</span>)</span><br><span class="line"></span><br><span class="line">user_parser = reqparse.RequestParser()</span><br><span class="line">user_parser.add_argument(<span class="string">'name'</span>, location=<span class="string">'form'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>type</strong> keyword specify the argument’s type. Allowed values are <strong>int</strong>, <strong>str</strong>, <strong>bool</strong>.</li>
<li><strong>location</strong> keyword specify arguments to be present in the query of your method in the header or request body.</li>
<li><strong>action</strong> keywork and <strong>append</strong> value create an argument which accepts multiple values.</li>
</ul>
<p>Read more about <a href="http://flask-restplus.readthedocs.io/en/0.9.2/api.html#module-flask_restplus.reqparse" target="_blank" rel="noopener">RequestParser in the Flask-RestPlus docs</a>.</p>
<p>Like mention in previous section, once the model is defined you can attach it to a method using the <strong>@api.expect()</strong> decorator:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ns.route('/')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">showListUsers</span><span class="params">(Resource)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">        ...</span><br><span class="line"><span class="meta">    @api.expect(user_parser)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<h4 id="Add-namespaces-to-application"><a href="#Add-namespaces-to-application" class="headerlink" title="Add namespaces to application"></a>Add namespaces to application</h4><p>It’s time to add namespaces has been created in previous section to application by replacing following code into <strong>app.py</strong> file:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Blueprint</span><br><span class="line"><span class="keyword">from</span> restplus <span class="keyword">import</span> api</span><br><span class="line"><span class="keyword">from</span> services.user <span class="keyword">import</span> ns <span class="keyword">as</span> user_namespace</span><br><span class="line"><span class="keyword">from</span> services.movies <span class="keyword">import</span> ns <span class="keyword">as</span> movies_namespace</span><br><span class="line"><span class="keyword">from</span> services.bookings <span class="keyword">import</span> ns <span class="keyword">as</span> bookings_namespace</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_app</span><span class="params">(flask_app)</span>:</span></span><br><span class="line">    blueprint = Blueprint(<span class="string">'api'</span>, __name__, url_prefix=<span class="string">'/api'</span>)</span><br><span class="line">    api.init_app(blueprint)</span><br><span class="line">    flask_app.register_blueprint(blueprint)</span><br><span class="line">    api.add_namespace(user_namespace)</span><br><span class="line">    api.add_namespace(movies_namespace)</span><br><span class="line">    api.add_namespace(bookings_namespace)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    initialize_app(app)</span><br><span class="line">    app.run(host=<span class="string">"0.0.0.0"</span>, debug=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>Take a look into the <strong>app.py</strong> file and the <strong>initialize_app</strong> function.</p>
<p>This function does a number of things, but in particular it sets up a <a href="http://flask.pocoo.org/docs/0.11/blueprints/" target="_blank" rel="noopener">Flask blueprint</a>, which will host the API under the /api URL prefix. This allows you to separate the API part of your application from other parts. Your app’s frontend could be hosted in the same Flask application but under a different <strong>blueprint</strong> (perhaps with the <strong>/</strong> URL prefix).</p>
<p>In order to add these namespaces to the API, we need to use the <strong>api.add_namespace()</strong> function.</p>
<p>In your brower, open the URL <a href="http://localhost:30/api/" target="_blank" rel="noopener">http://localhost:30/api/</a>. You should see Swagger UI similar to the following:</p>
<img src="/2018/01/15/Building-microservices-using-Flask-RestPlus-Swagger-UI-RabbitMQ-and-Nameko/swagger-ui-final.png">
<h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>In this article, a simple application with microservices architecture has been constructed. In this process, we have learned how to use Docker, Nameko, Flask RestPlus, RabbitMQ to build project step by step. Finally, we can see the advantages and disadvantages of microservices architecture compare with tradition monolithic architecture.</p>
<p>This is the <a href="https://github.com/quanrong88/microservices-demo" target="_blank" rel="noopener">final source</a> of this project.</p>
<p>Also, I created the <a href="https://github.com/quanrong88/BookingMovie" target="_blank" rel="noopener">IOS application</a> using API was developed in this project.</p>
<blockquote>
<p>To build and run this system is require typing a lot of commands so I created a yaml file docker-compose.yml. Then, you just need to run :<br>$ docker-compose up<br>all microservice containers will be start automatically.</p>
</blockquote>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-01-15</span><i class="fa fa-tag"></i><a href="/tags/Flask-RESTPlus/" title="Flask-RESTPlus" class="tag">Flask-RESTPlus </a><a href="/tags/Docker/" title="Docker" class="tag">Docker </a><a href="/tags/RabbitMQ/" title="RabbitMQ" class="tag">RabbitMQ </a><a href="/tags/Flask/" title="Flask" class="tag">Flask </a><a href="/tags/RESTful/" title="RESTful" class="tag">RESTful </a><a href="/tags/Swagger/" title="Swagger" class="tag">Swagger </a><a href="/tags/Nameko/" title="Nameko" class="tag">Nameko </a><a href="/tags/microservices/" title="microservices" class="tag">microservices </a><a href="/tags/MySQL/" title="MySQL" class="tag">MySQL </a><a href="/tags/Obj-C/" title="Obj-C" class="tag">Obj-C </a><a href="/tags/Python/" title="Python" class="tag">Python </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://quanrong88.github.io/2018/01/15/Building-microservices-using-Flask-RestPlus-Swagger-UI-RabbitMQ-and-Nameko/,Tạ Quân,Building microservices using Docker, Flask-RestPlus, Swagger UI, RabbitMQ and Nameko,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2018/03/13/Building-microservice-with-GRPC-and-python/" title="Building microservice with gRPC and python" class="btn">prev post</a></li><li class="next pagbuttons"><a role="navigation" href="/2018/01/03/Refactoring-code-with-Protocol-orient-programming-in-Swift-3/" title="Refactoring code with Protocol oriented Programming in Swift 3" class="btn">next post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>