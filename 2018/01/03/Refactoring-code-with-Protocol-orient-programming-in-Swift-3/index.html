<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Tạ Minh Quân,ta.quan@icloud.com"><title>Refactoring code with Protocol oriented Programming in Swift 3 · Tạ Quân</title><meta name="description" content="In this article, we going to take a look at some common issues with application design. We’ll find out the limitation of classical Object-Oriented Pro"><meta name="keywords" content="Hexo,Swift,Refactoring,iOS,Docker"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Tạ Quân</a></h3><div class="description"><p>Just make it simple.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/quanrong"><i class="fa fa-twitter"></i></a></li><li><a href="http://facebook.com/churongmayman"><i class="fa fa-facebook"></i></a></li><li><a href="http://github.com/quanrong88"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Archive</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"></a></li></div><div class="avatar"><img src="/images/blog_ava.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Refactoring code with Protocol oriented Programming in Swift 3</a></h3></div><div class="post-content"><p>In this article, we going to take a look at some common issues with application design. We’ll find out the limitation of classical Object-Oriented Programming and how we can address those using a different approach. In this case, we’ll examine refactoring code with POP approach.</p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p>Protocol-Oriented Programming is a new programming paradigm ushered in by Swift 2.0. In the Protocol-Oriented approach, we start designing our system by defining protocols. We rely on new concepts: protocol extensions, protocol inheritance, and protocol compositions. The paradigm also changes how we view semantics. In Swift, value types are preferred over classes. However, objeaoriented concepts don’t work well with structs and enums: a struct cannot inherit from another struct, neither can an enum inherit from another enum. So inheritancefa - one of the fundamental object-oriented concepts - cannot be applied to value types. On the other hand, value types can inherit from protocols, even multiple protocols. Thus, with POP, value types have become first class citizens in Swift.</p>
<p>The aims of this project are to examine the POP paradigm in current project and to compare POP with classical OOP.</p>
<h3 id="Classical-Inheritance-OOP"><a href="#Classical-Inheritance-OOP" class="headerlink" title="Classical Inheritance OOP"></a>Classical Inheritance OOP</h3><p><strong>Inheritance</strong> is a useful technique in OOP but it has some limitation in representing the complexity required by relationships among application entities. To demonstrate, let’s start with class diagram of animal:</p>
<img src="/2018/01/03/Refactoring-code-with-Protocol-orient-programming-in-Swift-3/animalOOP.png">
<p>In above scenario, our animal don’t seem to be fit well with the inheritance pattern. The signification of this issue are <em>duck</em> and <em>exocoetidae</em>. <em>Duck</em> is not fish but they can swim and <em>exocoetidae</em> is not bird but they can fly. This counterexample to notion that it is not possible to implement <em>swim()</em> method of <em>Fish</em> class inside <em>Duck</em> and the same with <em>fly()** method of </em>Bird<em> class inside </em>exocoetidae*.</p>
<p>A possible solution would be to duplicate the required code for each new subclass. It looks easy, but then we need to deal with a lot of code duplication. In order to avoid that, we put these methods to closest super class. But this will make complex base class.</p>
<h3 id="Better-Approach-POP"><a href="#Better-Approach-POP" class="headerlink" title="Better Approach POP"></a>Better Approach POP</h3><p>Swift, just like many other programming languages, does not support multiple inheritance. The previous approach, you’d have to keep adding new functionality to your superclass or otherwise create new intermediary class, thereby complicating issue. In new approach, we’re going to use <em>Protocol</em> to solve this issue. Protocols serve as blueprints: they tell us what adopters shall implement, but you can’t provide implementation within a protocol. Luckily, there is another way: <em>protocol extensions</em> are the way to go! In Swift, you can extend a protocol and provide default implementation for methods, computed properties, subscripts and convenience initializers. The following class diagram show the changes in implementation:</p>
<img src="/2018/01/03/Refactoring-code-with-Protocol-orient-programming-in-Swift-3/animalPOP.png">
<p>Swift does not allow multiple inheritance for classes. However, Swift types can adopt multiple protocols. In below diagram, we use 3 protocols <em>Swimable</em>, <em>Flyable</em>, <em>Eatable</em>. Now, <em>Duck</em> and <em>exocoetidae</em> class adopt all 3 protocols, other class like <em>Tuna</em> only adopts <em>Swimable</em> and <em>Eatable</em> protocols. This design not only is more flexible than squeezing all the required functionality into a monolithic base class but also works for value types.</p>
<h3 id="Refactoring-Our-Project"><a href="#Refactoring-Our-Project" class="headerlink" title="Refactoring Our Project"></a>Refactoring Our Project</h3><p>In current project, there are 2 files can be refactor using POP : <em>MapAnnotation</em> and <em>FeedViewModel</em>. Both of them have <em>image()</em> method to get the icon image but <em>FeedViewModel</em> is a struct , <em>MapAnnotation</em> is subclass of MKAnnotation. You can not use a superclass in this case. The following diagram show the current structure of 2 files:</p>
<img src="/2018/01/03/Refactoring-code-with-Protocol-orient-programming-in-Swift-3/currentDiagram.png">
<p>In this case, POP and <em>Protocol extension</em> are the best choice. Also, to make feed screen synchronize with map screen, we will display the icon inside a round bubble like map screen. This following class diagram show how to solve above problem with new approach:</p>
<img src="/2018/01/03/Refactoring-code-with-Protocol-orient-programming-in-Swift-3/refactoringPOP.png">
<p>You create 2 new protocols <em>GetableIconImage</em> and <em>GetableTintColor</em> and their <em>protocol extension</em> to implement <em>image()</em> and <em>makerTintColor()</em> methods. Then, <em>MapAnnotation</em> and <em>FeedViewModel</em> are going to adopt them.</p>
<p>Go to <strong>File\New\File…</strong>, select <strong>iOS\Source\Swift File</strong> template and click <strong>Next</strong>. Name the file <strong>GetableIconImage</strong> and click <strong>Create</strong> to save the file. Add the following contents:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">GetableIconImage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> type: <span class="type">RestaurantType</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">GetableIconImage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> image: <span class="type">UIImage</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> type &#123;</span><br><span class="line">        <span class="keyword">case</span> .hawk:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"bakery"</span>)</span><br><span class="line">        <span class="keyword">case</span> .coffee:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"coffee"</span>)</span><br><span class="line">        <span class="keyword">case</span> .fastfood:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"fastfood"</span>)</span><br><span class="line">        <span class="keyword">case</span> .streettea:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"water"</span>)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> #imageLiteral(resourceName: <span class="string">"food-icon"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Next, Go to <strong>File\New\File…</strong>, select <strong>iOS\Source\Swift File</strong> template and click <strong>Next</strong>. Name the file <strong>GetableTintColor</strong> and click <strong>Create</strong> to save the file. Add the following contents:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">GetableTintColor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> type: <span class="type">RestaurantType</span> &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">GetableTintColor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> makerTintColor: <span class="type">UIColor</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> type &#123;</span><br><span class="line">        <span class="keyword">case</span> .hawk:</span><br><span class="line">            <span class="keyword">return</span> .orange</span><br><span class="line">        <span class="keyword">case</span> .coffee:</span><br><span class="line">            <span class="keyword">return</span> .brown</span><br><span class="line">        <span class="keyword">case</span> .fastfood:</span><br><span class="line">            <span class="keyword">return</span> .yellow</span><br><span class="line">        <span class="keyword">case</span> .streettea:</span><br><span class="line">            <span class="keyword">return</span> .green</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> .red</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Finally, let your <strong>MapAnnotation</strong> class and <strong>FeedViewModel</strong> struct adopt both protocol. Your <strong>MapAnnotation.swift</strong> file should look like following:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"><span class="keyword">import</span> MapKit</span><br><span class="line"><span class="keyword">import</span> Contacts</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MapAnnotation</span>: <span class="title">NSObject</span>, <span class="title">MKAnnotation</span>, <span class="title">GetableIconImage</span>, <span class="title">GetableTintColor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> title: <span class="type">String</span>?</span><br><span class="line">    <span class="keyword">var</span> subtitle: <span class="type">String</span>?</span><br><span class="line">    <span class="keyword">var</span> type: <span class="type">RestaurantType</span></span><br><span class="line">    <span class="keyword">var</span> coordinate: <span class="type">CLLocationCoordinate2D</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(restaurant: <span class="type">RestaurantDataModel</span>) &#123;</span><br><span class="line">        title = restaurant.name</span><br><span class="line">        subtitle = restaurant.bio</span><br><span class="line">        type = restaurant.type</span><br><span class="line">        coordinate = <span class="type">CLLocationCoordinate2D</span>(latitude: restaurant.latitude, longitude: restaurant.longitude)</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Annotation right callout accessory opens this mapItem in Maps app</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">mapItem</span><span class="params">()</span></span> -&gt; <span class="type">MKMapItem</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> addressDict = [<span class="type">CNPostalAddressStreetKey</span>: subtitle!]</span><br><span class="line">        <span class="keyword">let</span> placemark = <span class="type">MKPlacemark</span>(coordinate: coordinate, addressDictionary: addressDict)</span><br><span class="line">        <span class="keyword">let</span> mapItem = <span class="type">MKMapItem</span>(placemark: placemark)</span><br><span class="line">        mapItem.name = title</span><br><span class="line">        <span class="keyword">return</span> mapItem</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And, your <strong>FeedViewModel.swift</strong> file should look like following:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> UIKit</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FeedViewModel</span>: <span class="title">GetableIconImage</span>, <span class="title">GetableTintColor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">var</span> type: <span class="type">RestaurantType</span></span><br><span class="line">    <span class="keyword">var</span> rate: <span class="type">Double</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(dataModel: <span class="type">RestaurantDataModel</span>) &#123;</span><br><span class="line">        name = dataModel.name</span><br><span class="line">        type = dataModel.type</span><br><span class="line">        rate = dataModel.rate</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Build and run project, your feed screen should look like this:</p>
<img src="/2018/01/03/Refactoring-code-with-Protocol-orient-programming-in-Swift-3/finalFeedScreen.png">
<h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>In this article, project has been refactored using POP paradigm. You have figured out the common issue with OOP and the new approach with POP. Based on these findings, you can find the better class hierarchy that clean and easy to maintain.</p>
<p>Here is the <a href="https://github.com/quanrong88/DummyMap/tree/part3" target="_blank" rel="noopener">final project</a> of this part.</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-01-03</span><i class="fa fa-tag"></i><a href="/tags/POP/" title="POP" class="tag">POP </a><a href="/tags/Swift/" title="Swift" class="tag">Swift </a><a href="/tags/Protocol-Oriented-Programming/" title="Protocol Oriented Programming" class="tag">Protocol Oriented Programming </a><a href="/tags/MapKit/" title="MapKit" class="tag">MapKit </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://quanrong88.github.io/2018/01/03/Refactoring-code-with-Protocol-orient-programming-in-Swift-3/,Tạ Quân,Refactoring code with Protocol oriented Programming in Swift 3,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2018/01/15/Building-microservices-using-Flask-RestPlus-Swagger-UI-RabbitMQ-and-Nameko/" title="Building microservices using Docker, Flask-RestPlus, Swagger UI, RabbitMQ and Nameko" class="btn">prev post</a></li><li class="next pagbuttons"><a role="navigation" href="/2017/12/27/Refactoring-code-with-MVVM-in-Swift-3/" title="Refactoring code with MVVM in Swift 3" class="btn">next post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>