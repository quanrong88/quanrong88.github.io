<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Tạ Minh Quân,ta.quan@icloud.com"><title>Building microservice with gRPC and python · Tạ Quân</title><meta name="description" content="This article demonstrates using gRPC technology in microservices architecture. The project show the new features of gRPC and apply it into a simple mi"><meta name="keywords" content="Hexo,Swift,Refactoring,iOS,Docker"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Tạ Quân</a></h3><div class="description"><p>Just make it simple.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/quanrong"><i class="fa fa-twitter"></i></a></li><li><a href="http://facebook.com/churongmayman"><i class="fa fa-facebook"></i></a></li><li><a href="http://github.com/quanrong88"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">About</a></li><li><a href="/archives">Archive</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"></a></li></div><div class="avatar"><img src="/images/blog_ava.jpg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Building microservice with gRPC and python</a></h3></div><div class="post-content"><p>This article demonstrates using gRPC technology in microservices architecture. The project show the new features of gRPC and apply it into a simple microservices project. You can have an overview of this technology and how to use it in real world project.</p>
<h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p><strong>gRPC</strong> is an open source <a href="https://en.wikipedia.org/wiki/Remote_procedure_call" target="_blank" rel="noopener">remote procedure call</a> (RPC) system initially developed at Google. It uses HTTP/2 for transport, <a href="https://en.wikipedia.org/wiki/Protocol_Buffers" target="_blank" rel="noopener">Protocol Buffers</a> as the <a href="https://en.wikipedia.org/wiki/Interface_description_language" target="_blank" rel="noopener">interface description language</a>, and provides features such as authentication, bidirectional streaming and flow control, blocking or nonblocking bindings, and cancellation and timeouts. It generates cross-platform client and server bindings for many languages.</p>
<p>Like <a href="https://quanrong88.github.io/2018/01/15/Building-microservices-using-Flask-RestPlus-Swagger-UI-RabbitMQ-and-Nameko/">previous article</a>, you’re going to use <strong>Docker</strong> to build microservices. You should have the basic understanding some basic commands of <strong>Docker</strong> before getting start.</p>
<p>The following sequence diagram show the final operations of the project:</p>
<img src="/2018/03/13/Building-microservice-with-GRPC-and-python/grpc-demo-project.png">
<p>The aims of this project are to setup a simple microservices application and to use gRPC for communicating messages between services.</p>
<h3 id="Setup-container-communication"><a href="#Setup-container-communication" class="headerlink" title="Setup container communication"></a>Setup container communication</h3><p>The first step for setting up project environment is creating a docker network. It allows containers communicate within it. Bridge networks offer the easiest solution to create your own Docker network. Open <strong>Terminal</strong> and type following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create -d bridge qNet</span><br></pre></td></tr></table></figure>
<h3 id="Setup-Users-module"><a href="#Setup-Users-module" class="headerlink" title="Setup Users module"></a>Setup Users module</h3><p>In this section, you’re going to create a docker container for users data management. First, you need generate protobuf files by compiling the <strong>users.proto</strong> file. The content for <strong>users.proto</strong> is shown below.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line">message UserRequest &#123;</span><br><span class="line">    int32 userId = 1;</span><br><span class="line">&#125;</span><br><span class="line">message UserResponse &#123;</span><br><span class="line">    string name = 1;</span><br><span class="line">    string imageUrl = 2;</span><br><span class="line">&#125;</span><br><span class="line">service Users &#123;</span><br><span class="line">    rpc RequestUser (UserRequest) returns (UserResponse) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>By using the <a href="https://grpc.io/docs/tutorials/basic/python.html" target="_blank" rel="noopener">grpcio-tools</a> to compile the <strong>users.proto</strong> file, you can get the <strong>users_pb2.py</strong> and <strong>users_pb2_grpc.py</strong> two files.</p>
<p>The compile command is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. users.proto</span><br></pre></td></tr></table></figure>
<p>Then you create the server using the grpc generated python file.</p>
<p>The <strong>server.py</strong> file:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> users_pb2</span><br><span class="line"><span class="keyword">import</span> users_pb2_grpc</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">_ONE_DAY_IN_SECONDS = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span></span><br><span class="line"></span><br><span class="line">data = json.load(open(<span class="string">'users.json'</span>))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersService</span><span class="params">(users_pb2_grpc.UsersServicer)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">RequestUser</span><span class="params">(self, request, context)</span>:</span></span><br><span class="line">        filterResult = list(filter(<span class="keyword">lambda</span> user: user[<span class="string">'id'</span>] == request.userId, data))</span><br><span class="line">        userDic = filterResult[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> users_pb2.UserResponse(name = userDic[<span class="string">'name'</span>], imageUrl = userDic[<span class="string">'imgUrl'</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serve</span><span class="params">()</span>:</span></span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    users_pb2_grpc.add_UsersServicer_to_server(UsersService(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">'[::]:22222'</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            time.sleep(_ONE_DAY_IN_SECONDS)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.stop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  serve()</span><br></pre></td></tr></table></figure>
<p>In this project, the service file is very simple , it just get data from json file and pass it to grpc message.</p>
<p>Next, you need to create <strong>Dockerfile</strong> to build the docker container for users module. The content of <strong>Dockerfile</strong> is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM grpc/python:1.4</span><br><span class="line">ADD . /code</span><br><span class="line">WORKDIR /code</span><br><span class="line">EXPOSE 22222</span><br><span class="line">CMD [&quot;python&quot;, &quot;server.py&quot;]</span><br></pre></td></tr></table></figure>
<p>Run following command to build the docker image:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t uses-module ./users</span><br></pre></td></tr></table></figure>
<p>Then run the docker container by using this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -it --name users-module --net qNet -v $(pwd)/users:/code users-module</span><br></pre></td></tr></table></figure>
<h3 id="Setup-comments-module"><a href="#Setup-comments-module" class="headerlink" title="Setup comments module"></a>Setup comments module</h3><p>This module uses for comments data management. Similar to users module, you create the <strong>comments.proto</strong> file for it. The content of <strong>comments.proto</strong> file is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line">message CommentsRequest &#123;</span><br><span class="line">    int32 contentId = 1;</span><br><span class="line">&#125;</span><br><span class="line">message CommentsResponse &#123;</span><br><span class="line">    message Comment &#123;</span><br><span class="line">      string content = 1;</span><br><span class="line">      string name = 2;</span><br><span class="line">      string imageUrl = 3;</span><br><span class="line">    &#125;</span><br><span class="line">    repeated Comment comments = 1;</span><br><span class="line">&#125;</span><br><span class="line">service Comments &#123;</span><br><span class="line">    rpc RequestComments (CommentsRequest) returns (CommentsResponse) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then, you generate <strong>comments_pb2.py</strong> and <strong>comments_pb2_grpc.py</strong> using this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. comments.proto</span><br></pre></td></tr></table></figure>
<p>In this section, you need to get data from users module so copy <strong>users_pb2.py</strong> and <strong>users_pb2_grpc.py</strong> from previous part to <strong>/comments</strong> directory.</p>
<p>Next, create the service file. The content of <strong>server.py</strong> is:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> comments_pb2</span><br><span class="line"><span class="keyword">import</span> comments_pb2_grpc</span><br><span class="line"><span class="keyword">import</span> users_pb2</span><br><span class="line"><span class="keyword">import</span> users_pb2_grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">_ONE_DAY_IN_SECONDS = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span></span><br><span class="line"></span><br><span class="line">data = json.load(open(<span class="string">'comments.json'</span>))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentsService</span><span class="params">(comments_pb2_grpc.CommentsServicer)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">RequestComments</span><span class="params">(self, request, context)</span>:</span></span><br><span class="line">        contentId = request.contentId</span><br><span class="line">        comments = list(filter(<span class="keyword">lambda</span> comment: comment[<span class="string">'contentId'</span>] == contentId, data))</span><br><span class="line">        response = comments_pb2.CommentsResponse()</span><br><span class="line">        channel = grpc.insecure_channel(<span class="string">'users-module:22222'</span>)</span><br><span class="line">        stub = users_pb2_grpc.UsersStub(channel)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> comments:</span><br><span class="line">            comment = response.comments.add()</span><br><span class="line">            comment.content = item[<span class="string">'comment'</span>]</span><br><span class="line">            responseUser = stub.RequestUser(users_pb2.UserRequest(userId = item[<span class="string">'userId'</span>]))</span><br><span class="line">            comment.name = responseUser.name</span><br><span class="line">            comment.imageUrl = responseUser.imageUrl</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serve</span><span class="params">()</span>:</span></span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    comments_pb2_grpc.add_CommentsServicer_to_server(CommentsService(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">'[::]:22222'</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            time.sleep(_ONE_DAY_IN_SECONDS)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.stop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  serve()</span><br></pre></td></tr></table></figure>
<p>The comments service get data content from <strong>comments.json</strong> file and request user information via gRPC message.</p>
<p>Next, you need to create <strong>Dockerfile</strong> to build the docker container for comments module. The content of <strong>Dockerfile</strong> is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM grpc/python:1.4</span><br><span class="line">ADD . /code</span><br><span class="line">WORKDIR /code</span><br><span class="line">EXPOSE 22222</span><br><span class="line">CMD [&quot;python&quot;, &quot;server.py&quot;]</span><br></pre></td></tr></table></figure>
<p>Run following command to build the docker image:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t uses-module ./comments</span><br></pre></td></tr></table></figure>
<p>Then run the docker container by using this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -it --name comments-module --net qNet -v $(pwd)/comments:/code comments-module</span><br></pre></td></tr></table></figure>
<h3 id="Setup-Locations-module"><a href="#Setup-Locations-module" class="headerlink" title="Setup Locations module"></a>Setup Locations module</h3><p>Locations module uses for locations data management. First, you need to define proto file for this part. The content of <strong>locations.proto</strong> is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line">import &quot;google/api/annotations.proto&quot;;</span><br><span class="line">message LocationsRequest &#123;&#125;</span><br><span class="line">message Location &#123;</span><br><span class="line">    int32 id = 1;</span><br><span class="line">    string title = 2;</span><br><span class="line">    string subtitle = 3;</span><br><span class="line">    float lat = 4;</span><br><span class="line">    float long = 5;</span><br><span class="line">&#125;</span><br><span class="line">message LocationsResponse &#123;</span><br><span class="line">    repeated Location locations = 1;</span><br><span class="line">&#125;</span><br><span class="line">message LocationDetailRequest &#123;</span><br><span class="line">    int32 locationId = 1;</span><br><span class="line">&#125;</span><br><span class="line">message LocationDetailResponse &#123;</span><br><span class="line">    message Comment &#123;</span><br><span class="line">      string content = 1;</span><br><span class="line">      string name = 2;</span><br><span class="line">      string imageUrl = 3;</span><br><span class="line">    &#125;</span><br><span class="line">    Location location = 1;</span><br><span class="line">    repeated Comment comment = 2;</span><br><span class="line">&#125;</span><br><span class="line">service Locations &#123;</span><br><span class="line">    rpc RequestLocations (LocationsRequest) returns (LocationsResponse) &#123;</span><br><span class="line">        option (google.api.http).get = &quot;/locations&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    rpc RequestLocationDetail (LocationDetailRequest) returns (LocationDetailResponse) &#123;</span><br><span class="line">        option (google.api.http).get = &quot;/locations/&#123;locationId&#125;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can see the difference in this proto file is <strong>import “google/api/annotations.proto”;</strong> and the options in services code. You can find more useful information about it <a href="https://cloud.google.com/endpoints/docs/grpc/grpc-service-config" target="_blank" rel="noopener">here</a>. This options are going to use for generating reverse proxy code and swagger definition later in this article.</p>
<p>Then, you generate <strong>locations_pb2.py</strong> and <strong>locations_pb2_grpc.py</strong> using this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. locations.proto</span><br></pre></td></tr></table></figure>
<p>Copy <strong>comments_pb2.py</strong> and <strong>comments_pb2_grpc.py</strong> to <strong>/locations</strong> directory for communicating with comments module.</p>
<p>Next, you need create service file. The content of <strong>server.py</strong> file is:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> locations_pb2</span><br><span class="line"><span class="keyword">import</span> locations_pb2_grpc</span><br><span class="line"><span class="keyword">import</span> comments_pb2</span><br><span class="line"><span class="keyword">import</span> comments_pb2_grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">_ONE_DAY_IN_SECONDS = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span></span><br><span class="line">data = json.load(open(<span class="string">'locations.json'</span>))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LocationsService</span><span class="params">(locations_pb2_grpc.LocationsServicer)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">RequestLocations</span><span class="params">(self, request, context)</span>:</span></span><br><span class="line">        response = locations_pb2.LocationsResponse()</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> data:</span><br><span class="line">            location = response.locations.add()</span><br><span class="line">            location.id = item[<span class="string">'id'</span>]</span><br><span class="line">            location.title = item[<span class="string">'title'</span>]</span><br><span class="line">            location.subtitle = item[<span class="string">'subtitle'</span>]</span><br><span class="line">            location.lat = item[<span class="string">'lat'</span>]</span><br><span class="line">            location.long = item[<span class="string">'long'</span>]</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">RequestLocationDetail</span><span class="params">(self, request, context)</span>:</span></span><br><span class="line">        contentId = request.locationId</span><br><span class="line">        filterResult = list(filter(<span class="keyword">lambda</span> location: location[<span class="string">'id'</span>] == contentId, data))</span><br><span class="line">        locationDic = filterResult[<span class="number">0</span>]</span><br><span class="line">        channel = grpc.insecure_channel(<span class="string">'comments-module:22222'</span>)</span><br><span class="line">        stub = comments_pb2_grpc.CommentsStub(channel)</span><br><span class="line">        response = stub.RequestComments(comments_pb2.CommentsRequest(contentId = contentId))</span><br><span class="line">        detailResoponse = locations_pb2.LocationDetailResponse(location = locations_pb2.Location(id = locationDic[<span class="string">'id'</span>], title = locationDic[<span class="string">'title'</span>], subtitle = locationDic[<span class="string">'subtitle'</span>], lat = locationDic[<span class="string">'lat'</span>], long = locationDic[<span class="string">'long'</span>]))</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> response.comments:</span><br><span class="line">            comment = detailResoponse.comment.add()</span><br><span class="line">            comment.content = item.content</span><br><span class="line">            comment.name = item.name</span><br><span class="line">            comment.imageUrl = item.imageUrl</span><br><span class="line">        <span class="keyword">return</span> detailResoponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serve</span><span class="params">()</span>:</span></span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    locations_pb2_grpc.add_LocationsServicer_to_server(LocationsService(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">'[::]:22222'</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            time.sleep(_ONE_DAY_IN_SECONDS)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.stop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  serve()</span><br></pre></td></tr></table></figure>
<p>The comments service get data content from <strong>locations.json</strong> file and request comment information via gRPC message.</p>
<p>Next, you need to create <strong>Dockerfile</strong> to build the docker container for location module. The content of <strong>Dockerfile</strong> is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM grpc/python:1.4</span><br><span class="line">ADD . /code</span><br><span class="line">WORKDIR /code</span><br><span class="line">RUN pip install --upgrade gcloud</span><br><span class="line">RUN pip install --upgrade google-api-python-client</span><br><span class="line">EXPOSE 22222</span><br><span class="line">CMD [&quot;python&quot;, &quot;server.py&quot;]</span><br></pre></td></tr></table></figure>
<p>Run following command to build the docker image:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t locations-module ./locations</span><br></pre></td></tr></table></figure>
<p>Then run the docker container by using this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -it --name locations-module --net qNet -v $(pwd)/locations:/code locations-module</span><br></pre></td></tr></table></figure>
<p>Now, the our backend site of application has been finished. You will create client site to test it in next section.</p>
<h3 id="Setup-the-client-side"><a href="#Setup-the-client-side" class="headerlink" title="Setup the client side"></a>Setup the client side</h3><p>Role of client is sending request and displaying the result. Firstly, copy the <strong>locations_pb2.py</strong> and <strong>locations_pb2_grpc.py</strong> to <strong>/location-clients</strong> directory. Then, create the service file, the content of <strong>client.py</strong> is:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">import</span> locations_pb2</span><br><span class="line"><span class="keyword">import</span> locations_pb2_grpc</span><br><span class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pprint</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">()</span>:</span></span><br><span class="line">    channel = grpc.insecure_channel(<span class="string">'locations-module:22222'</span>)</span><br><span class="line">    stub = locations_pb2_grpc.LocationsStub(channel)</span><br><span class="line">    response = stub.RequestLocationDetail(locations_pb2.LocationDetailRequest(locationId = <span class="number">1</span>))</span><br><span class="line">    pprint(response)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  run()</span><br></pre></td></tr></table></figure>
<p>Now, create the Dockerfile to build docker image, the content of it is:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM grpc/python:1.4</span><br><span class="line">ADD . /code</span><br><span class="line">WORKDIR /code</span><br><span class="line">RUN pip install --upgrade gcloud</span><br><span class="line">RUN pip install --upgrade google-api-python-client</span><br></pre></td></tr></table></figure>
<p>Run following command to build the docker image:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t location-client-module ./locations-clients</span><br></pre></td></tr></table></figure>
<p>Then run the docker container by using this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d -it --name location-client-module --net qNet -v $(pwd)/locations-clients:/code location-client-module</span><br></pre></td></tr></table></figure>
<p>Final step is testing, run this command to access to location-client-module module ‘s command prompt:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it location-client-module bash</span><br></pre></td></tr></table></figure>
<p>Run the <strong>client.py</strong> inside this container, you should see the following output:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># python client.py</span><br><span class="line">location &#123;</span><br><span class="line">  id: 1</span><br><span class="line">  title: &quot;Test location 1&quot;</span><br><span class="line">  subtitle: &quot;Fun fun fun fun&quot;</span><br><span class="line">  lat: 21.029273986816406</span><br><span class="line">  long: 105.84941864013672</span><br><span class="line">&#125;</span><br><span class="line">comment &#123;</span><br><span class="line">  content: &quot;This is bad&quot;</span><br><span class="line">  name: &quot;Spider man&quot;</span><br><span class="line">  imageUrl: &quot;http://www.memes.at/faces/spiderpman.jpg&quot;</span><br><span class="line">&#125;</span><br><span class="line">comment &#123;</span><br><span class="line">  content: &quot;%&amp;%&amp;&amp;((**))&quot;</span><br><span class="line">  name: &quot;Troller&quot;</span><br><span class="line">  imageUrl: &quot;http://www.memes.at/faces/troll_face.jpg&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>At this point, you have completed all the microservices application. The next section is discussing advance topic about generating reverse proxy and swagger definition</p>
<h3 id="Set-up-API-gateway-Experimental"><a href="#Set-up-API-gateway-Experimental" class="headerlink" title="Set up API gateway (Experimental)"></a>Set up API gateway (Experimental)</h3><p>grpc-gateway is a plugin of <a href="http://github.com/google/protobuf" target="_blank" rel="noopener">protoc</a>.It reads <a href="http://github.com/grpc/grpc-common" target="_blank" rel="noopener">gRPC</a> service definition, and generates a reverse-proxy server which translates a RESTful JSON API into gRPC. This server is generated according to <a href="https://cloud.google.com/service-management/reference/rpc/google.api#http" target="_blank" rel="noopener">custom options</a> in your gRPC definition.</p>
<img src="/2018/03/13/Building-microservice-with-GRPC-and-python/grpc-gateway-diagram.png">
<p>You can find more information about it <a href="https://github.com/grpc-ecosystem/grpc-gateway/blob/master/README.md" target="_blank" rel="noopener">here</a></p>
<p>In <strong>/grpc-gateway</strong> directory is the reverse proxy container code. You can build it by running this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build -t locations-gateway ./grpc-gateway</span><br></pre></td></tr></table></figure>
<p>Run this container by run this command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run --name locations-gateway --net qNet -p 8080:80 locations-gateway --backend=locations-module:22222</span><br></pre></td></tr></table></figure>
<p>Testing the proxy container, by running this commad to get the json data of location with id 3:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://localhost:8080/locations/3</span><br><span class="line">&#123;&quot;location&quot;:&#123;&quot;id&quot;:3,&quot;title&quot;:&quot;Test location 3&quot;,&quot;subtitle&quot;:&quot;Fun fun fun fun&quot;,&quot;lat&quot;:21.026318,&quot;long&quot;:105.85042&#125;,&quot;comment&quot;:[&#123;&quot;content&quot;:&quot;This is spam&quot;,&quot;name&quot;:&quot;Quan&quot;,&quot;imageUrl&quot;:&quot;http://www.memes.at/faces/wow.jpg&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure>
<p>You can also convert the swagger definition file to other programming languages like swift, objC … It’s my most interesting feature of grpc-gateway plugin. You can find the swagger definition file in <strong>/grpc-gateway/src/gen/pb-go/locations.swagger.json</strong> and use <a href="https://editor.swagger.io" target="_blank" rel="noopener">swagger editor</a> to convert.</p>
<p>You can check out my <a href="https://github.com/quanrong88/DummyLocationIOS" target="_blank" rel="noopener">IOS swift client</a> for this project.</p>
<h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>In this article, a microservice application has been constructed using gRPC to communicating. During process you have review the basic feature of gRPC by real example.</p>
<p>Final code for this project can find <a href="https://github.com/quanrong88/DummyLocations" target="_blank" rel="noopener">here</a></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-03-13</span><i class="fa fa-tag"></i></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://quanrong88.github.io/2018/03/13/Building-microservice-with-GRPC-and-python/,Tạ Quân,Building microservice with gRPC and python,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a role="navigation" href="/2018/01/15/Building-microservices-using-Flask-RestPlus-Swagger-UI-RabbitMQ-and-Nameko/" title="Building microservices using Docker, Flask-RestPlus, Swagger UI, RabbitMQ and Nameko" class="btn">next post</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>